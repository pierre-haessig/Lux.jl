


<a id='Training-a-Neural-ODE-to-Model-Gravitational-Waveforms'></a>

# Training a Neural ODE to Model Gravitational Waveforms


This code is adapted from [Astroinformatics/ScientificMachineLearning](https://github.com/Astroinformatics/ScientificMachineLearning/blob/c93aac3a460d70b4cce98836b677fd9b732e94b7/neuralode_gw.ipynb)


The code has been minimally adapted from [Keith et. al. 2021](https://arxiv.org/abs/2102.12695) which originally used Flux.jl


<a id='Package-Imports'></a>

## Package Imports


```julia
using Lux, ComponentArrays, LineSearches, LuxAMDGPU, LuxCUDA, OrdinaryDiffEq,
    Optimization, OptimizationOptimJL, Random, SciMLSensitivity
using CairoMakie, MakiePublication
CUDA.allowscalar(false)
```


<a id='Define-some-Utility-Functions'></a>

## Define some Utility Functions


::: tip


This section can be skipped. It defines functions to simulate the model, however, from a scientific machine learning perspective, isn't super relevant.


:::


We need a very crude 2-body path. Assume the 1-body motion is a newtonian 2-body position vector $r = r_1 - r_2$ and use Newtonian formulas to get $r_1$, $r_2$ (e.g. Theoretical Mechanics of Particles and Continua 4.3)


```julia
function one2two(path, m₁, m₂)
    M = m₁ + m₂
    r₁ = m₂ / M .* path
    r₂ = -m₁ / M .* path
    return r₁, r₂
end
```


```
one2two (generic function with 1 method)
```


Next we define a function to perform the change of variables: $(\chi(t),\phi(t)) \mapsto (x(t),y(t))$


```julia
@views function soln2orbit(soln, model_params=nothing)
    @assert size(soln, 1) ∈ [2, 4] "size(soln,1) must be either 2 or 4"

    if size(soln, 1) == 2
        χ = soln[1, :]
        ϕ = soln[2, :]

        @assert length(model_params)==3 "model_params must have length 3 when size(soln,2) = 2"
        p, M, e = model_params
    else
        χ = soln[1, :]
        ϕ = soln[2, :]
        p = soln[3, :]
        e = soln[4, :]
    end

    r = p ./ (1 .+ e .* cos.(χ))
    x = r .* cos.(ϕ)
    y = r .* sin.(ϕ)

    orbit = vcat(x', y')
    return orbit
end
```


```
soln2orbit (generic function with 2 methods)
```


This function uses second-order one-sided difference stencils at the endpoints; see https://doi.org/10.1090/S0025-5718-1988-0935077-0


```julia
function d_dt(v::AbstractVector, dt)
    a = -3 / 2 * v[1] + 2 * v[2] - 1 / 2 * v[3]
    b = (v[3:end] .- v[1:(end - 2)]) / 2
    c = 3 / 2 * v[end] - 2 * v[end - 1] + 1 / 2 * v[end - 2]
    return [a; b; c] / dt
end
```


```
d_dt (generic function with 1 method)
```


This function uses second-order one-sided difference stencils at the endpoints; see https://doi.org/10.1090/S0025-5718-1988-0935077-0


```julia
function d2_dt2(v::AbstractVector, dt)
    a = 2 * v[1] - 5 * v[2] + 4 * v[3] - v[4]
    b = v[1:(end - 2)] .- 2 * v[2:(end - 1)] .+ v[3:end]
    c = 2 * v[end] - 5 * v[end - 1] + 4 * v[end - 2] - v[end - 3]
    return [a; b; c] / (dt^2)
end
```


```
d2_dt2 (generic function with 1 method)
```


Now we define a function to compute the trace-free moment tensor from the orbit


```julia
function orbit2tensor(orbit, component, mass=1)
    x = orbit[1, :]
    y = orbit[2, :]

    Ixx = x .^ 2
    Iyy = y .^ 2
    Ixy = x .* y
    trace = Ixx .+ Iyy

    if component[1] == 1 && component[2] == 1
        tmp = Ixx .- trace ./ 3
    elseif component[1] == 2 && component[2] == 2
        tmp = Iyy .- trace ./ 3
    else
        tmp = Ixy
    end

    return mass .* tmp
end

function h_22_quadrupole_components(dt, orbit, component, mass=1)
    mtensor = orbit2tensor(orbit, component, mass)
    mtensor_ddot = d2_dt2(mtensor, dt)
    return 2 * mtensor_ddot
end

function h_22_quadrupole(dt, orbit, mass=1)
    h11 = h_22_quadrupole_components(dt, orbit, (1, 1), mass)
    h22 = h_22_quadrupole_components(dt, orbit, (2, 2), mass)
    h12 = h_22_quadrupole_components(dt, orbit, (1, 2), mass)
    return h11, h12, h22
end

function h_22_strain_one_body(dt::T, orbit) where {T}
    h11, h12, h22 = h_22_quadrupole(dt, orbit)

    h₊ = h11 - h22
    hₓ = T(2) * h12

    scaling_const = √(T(π) / 5)
    return scaling_const * h₊, -scaling_const * hₓ
end

function h_22_quadrupole_two_body(dt, orbit1, mass1, orbit2, mass2)
    h11_1, h12_1, h22_1 = h_22_quadrupole(dt, orbit1, mass1)
    h11_2, h12_2, h22_2 = h_22_quadrupole(dt, orbit2, mass2)
    h11 = h11_1 + h11_2
    h12 = h12_1 + h12_2
    h22 = h22_1 + h22_2
    return h11, h12, h22
end

function h_22_strain_two_body(dt::T, orbit1, mass1, orbit2, mass2) where {T}
    # compute (2,2) mode strain from orbits of BH 1 of mass1 and BH2 of mass 2

    @assert abs(mass1 + mass2 - 1.0)<1e-12 "Masses do not sum to unity"

    h11, h12, h22 = h_22_quadrupole_two_body(dt, orbit1, mass1, orbit2, mass2)

    h₊ = h11 - h22
    hₓ = T(2) * h12

    scaling_const = √(T(π) / 5)
    return scaling_const * h₊, -scaling_const * hₓ
end

function compute_waveform(dt::T, soln, mass_ratio, model_params=nothing) where {T}
    @assert mass_ratio≤1 "mass_ratio must be <= 1"
    @assert mass_ratio≥0 "mass_ratio must be non-negative"

    orbit = soln2orbit(soln, model_params)
    if mass_ratio > 0
        m₂ = inv(T(1) + mass_ratio)
        m₁ = mass_ratio * m₂

        orbit₁, orbit₂ = one2two(orbit, m₁, m₂)
        waveform = h_22_strain_two_body(dt, orbit1, mass1, orbit2, mass2)
    else
        waveform = h_22_strain_one_body(dt, orbit)
    end
    return waveform
end
```


```
compute_waveform (generic function with 2 methods)
```


<a id='Simulating-the-True-Model'></a>

## Simulating the True Model


`RelativisticOrbitModel` defines system of odes which describes motion of point like particle in schwarzschild background, uses


$$
u[1] = \chi
$$


$$
u[2] = \phi
$$


where, $p$, $M$, and $e$ are constants


```julia
function RelativisticOrbitModel(u, (p, M, e), t)
    χ, ϕ = u

    numer = (p - 2 - 2 * e * cos(χ)) * (1 + e * cos(χ))^2
    denom = sqrt((p - 2)^2 - 4 * e^2)

    χ̇ = numer * sqrt(p - 6 - 2 * e * cos(χ)) / (M * (p^2) * denom)
    ϕ̇ = numer / (M * (p^(3 / 2)) * denom)

    return [χ̇, ϕ̇]
end

mass_ratio = 0.0         # test particle
u0 = Float64[π, 0.0]     # initial conditions
datasize = 250
tspan = (0.0f0, 6.0f4)   # timespace for GW waveform
tsteps = range(tspan[1], tspan[2]; length=datasize)  # time at each timestep
dt_data = tsteps[2] - tsteps[1]
dt = 100.0
const ode_model_params = [100.0, 1.0, 0.5]; # p, M, e
```


Let's simulate the true model and plot the results using `OrdinaryDiffEq.jl`


```julia
prob = ODEProblem(RelativisticOrbitModel, u0, tspan, ode_model_params)
soln = Array(solve(prob, RK4(); saveat=tsteps, dt, adaptive=false))
waveform = first(compute_waveform(dt_data, soln, mass_ratio, ode_model_params))

fig = with_theme(theme_web()) do
    fig = Figure()
    ax = CairoMakie.Axis(fig[1, 1]; xlabel="Time", ylabel="Waveform")

    l = lines!(ax, tsteps, waveform; linewidth=2, alpha=0.75)
    s = scatter!(ax, tsteps, waveform; markershape=:circle, markeralpha=0.25, alpha=0.5)

    axislegend(ax, [[l, s]], ["Waveform Data"])

    return fig
end
```


![](1_GravitationalWaveForm-24.png)


<a id='Defiing-a-Neural-Network-Model'></a>

## Defiing a Neural Network Model


Next, we define the neural network model that takes 1 input (time) and has two outputs. We'll make a function `ODE_model` that takes the initial conditions, neural network parameters and a time as inputs and returns the derivatives.


It is typically never recommended to use globals but incase you do use them, make sure to mark them as `const`.


We will deviate from the standard Neural Network initialization and use `WeightInitializers.jl`,


```julia
const nn = Chain(Base.Fix1(broadcast, cos),
    Dense(1 => 32, cos; init_weight=truncated_normal(; std=1e-4)),
    Dense(32 => 32, cos; init_weight=truncated_normal(; std=1e-4)),
    Dense(32 => 2; init_weight=truncated_normal(; std=1e-4)))
ps, st = Lux.setup(MersenneTwister(), nn)
```


```
((layer_1 = NamedTuple(), layer_2 = (weight = Float32[-0.00012616052; 0.00014660764; 0.00015070995; 2.2035718f-5; -8.254036f-5; 1.8704854f-5; -1.5950412f-5; 9.2603404f-5; -3.5738387f-5; -1.1666958f-5; 6.125607f-5; 2.1726268f-5; 8.564302f-5; 8.64038f-6; 4.1446572f-5; -0.000108067994; -8.74689f-6; 1.6406022f-5; -3.2490454f-5; -8.8932415f-5; -1.8538392f-5; 0.00019251875; -1.4560135f-5; 8.841512f-5; -6.7178f-5; -5.7206118f-5; 0.00017048047; -0.00012598338; -3.8328653f-5; 0.00010855934; 1.1100785f-5; 4.470951f-5;;], bias = Float32[0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0;;]), layer_3 = (weight = Float32[-6.961338f-5 -9.444449f-5 -0.00021123407 -0.000107378844 -0.00013134528 8.142565f-5 0.000117153795 -0.00014644468 7.0671136f-5 0.00015078945 5.4069344f-5 8.143049f-6 -0.00025223324 -3.0272024f-5 0.00026090926 -3.817461f-6 -1.1114495f-5 -0.000102307225 7.433372f-5 -3.267378f-5 -1.398377f-5 9.150174f-5 -3.3277414f-5 -1.8748673f-5 -8.490208f-5 6.5741355f-5 -1.3444263f-5 -0.00012244987 9.0988695f-5 -7.140811f-5 1.4249099f-6 2.4913788f-5; -4.020142f-5 -5.857015f-5 -1.5645064f-5 2.4619196f-5 1.2039016f-5 0.00013975789 -3.347f-5 -1.421199f-5 -4.0530525f-5 0.00016616362 -6.838252f-5 8.7362976f-5 -2.7749915f-5 0.00020814461 -0.00015251055 -3.8349364f-5 0.00021629504 0.00015427088 0.0001689681 4.015594f-5 4.8750985f-6 -6.5475026f-5 0.00011489624 3.2638858f-5 3.133003f-6 -4.02705f-5 -5.4650383f-5 -0.00015303608 7.4768184f-5 -2.801155f-5 0.0001631484 0.000121769335; -1.8749495f-5 6.509529f-5 9.0990456f-5 -2.9979037f-5 7.8921235f-5 -4.04545f-5 -4.6902478f-5 2.8513423f-5 0.00019611038 8.988936f-5 -7.668827f-5 7.66567f-6 -8.2775165f-5 4.4699013f-5 8.120577f-5 5.388196f-5 3.0614924f-6 -9.1468675f-5 -7.148864f-5 -0.00011565569 0.00014613316 -1.8123601f-5 0.00011429126 -9.0703375f-5 -8.05156f-5 3.0780848f-5 3.098146f-5 4.7025398f-5 -0.00013060888 -4.6439436f-5 0.00011527298 -2.3982668f-5; 1.0498369f-5 -7.9739664f-5 -1.9286313f-6 0.0001575664 2.6699618f-5 2.7848557f-5 -0.00015111502 1.2828797f-5 1.51960185f-5 -0.000107774256 -0.00017101788 0.00017029444 -0.000110187684 -6.5370434f-5 2.2934302f-5 -4.0940122f-5 -0.00034729633 -1.71884f-5 9.707325f-6 9.148975f-5 5.880219f-5 -2.1607212f-7 -4.5087905f-5 -8.702045f-5 -0.00016708848 5.146997f-5 0.00015444517 6.4987005f-5 0.00014326346 -2.1284492f-7 8.953697f-5 -1.8975772f-5; 0.000110079294 6.585255f-5 -9.079697f-5 2.7317896f-5 0.0001982907 -0.00026708803 3.7917085f-5 4.1215044f-6 8.389169f-5 4.428027f-5 7.927934f-5 0.00010952269 2.0497135f-5 -0.0001075745 -3.9649967f-5 -0.00022113393 -0.00015360446 1.0366774f-5 -0.00018248278 -6.443075f-5 -3.4984735f-6 0.00015199925 8.808013f-5 -0.00010862394 0.00016835202 -0.00019836651 6.112206f-5 0.00012663646 0.00012854855 2.7776747f-5 -3.618598f-5 -0.00018064598; 1.6459751f-5 7.018816f-5 8.322874f-5 3.6648515f-5 -0.00017313557 -5.843126f-5 -3.3160616f-6 -0.00017485587 -4.715777f-5 -8.354264f-5 -1.0368307f-5 -0.00017702462 5.6849898f-5 -6.987866f-5 -4.1963256f-5 0.00027283575 0.0001012955 1.798f-5 -0.00020617776 -9.359652f-5 0.00019265716 5.5925553f-5 6.921814f-5 6.9839676f-5 -7.47111f-5 -0.00014529965 0.00014868626 -0.0001302219 -1.3311724f-5 -0.00010050213 0.00016196918 -2.9886349f-5; 4.2155632f-5 5.4036354f-5 5.9293656f-5 7.729434f-5 -1.2435439f-6 0.00019128795 -0.00018354476 0.00016669178 1.5458665f-5 4.1687807f-5 -1.4922901f-5 2.4145107f-5 -0.00011565225 -2.5778674f-5 0.00012109309 -0.000113743656 -7.512753f-5 -0.00020314286 -1.8225552f-5 -4.5785237f-6 1.490317f-5 -2.3598952f-5 -3.08406f-5 -4.6709203f-5 0.0001088054 7.992599f-5 -9.406556f-5 3.7295777f-5 0.00017281705 6.120046f-5 -5.720587f-5 7.545698f-5; -5.5590866f-5 -2.6506876f-5 -0.00014158251 2.2283008f-5 4.443801f-6 -0.000160504 3.5904606f-5 -1.7574366f-5 0.00010649262 2.8244982f-5 7.6473734f-5 -4.5567664f-5 2.2080816f-5 8.63535f-5 0.000111195026 1.6960636f-5 0.00019514166 -5.7179477f-5 -0.00013451341 -5.3595035f-5 0.00013130034 -6.449035f-7 9.5278134f-5 4.5445242f-5 -9.6911135f-6 -8.117997f-5 -0.00019435935 0.00013634773 0.00016174084 3.594212f-5 -2.9692554f-5 1.6233445f-5; -4.0321987f-7 4.6576442f-5 5.933377f-5 -6.0971324f-5 -0.00013120919 -2.6821084f-5 -1.7904327f-5 3.8482913f-6 -0.00013149403 2.2982863f-6 0.00012818938 4.764447f-5 1.7082632f-5 -7.062373f-5 -3.096403f-5 0.00021003812 -0.00016579953 -0.00010996386 -4.138507f-5 -9.792732f-5 3.944779f-5 0.00013774078 0.00010113277 -8.53688f-5 -6.362311f-5 0.00015276592 -8.801638f-5 -4.9764152f-5 -5.9386944f-5 1.5414787f-5 8.9590874f-5 -6.487004f-6; -6.382889f-5 1.3811643f-5 -1.0402166f-5 0.00010136001 -8.9310684f-5 -7.286713f-5 3.401429f-5 -6.724605f-5 -6.19333f-5 4.1072566f-5 7.167616f-5 7.670788f-5 -5.271656f-6 2.7907083f-5 -8.6663196f-5 -1.1364262f-5 2.3883733f-6 3.3742006f-5 1.852155f-5 6.889921f-5 -4.6370053f-5 -5.2083586f-5 -8.682835f-5 -2.1218302f-5 -6.0590824f-5 8.727158f-5 7.0341106f-5 0.00022608366 -2.7800288f-5 -4.1810752f-5 -6.555758f-5 3.8235183f-5; 8.548488f-5 -4.2318487f-5 -5.165707f-5 -0.00017658305 -7.1500676f-7 1.6674689f-5 -5.3122894f-5 -3.4904337f-5 -2.7639844f-5 3.000726f-5 3.0861283f-5 -5.492964f-5 0.0001166571 -0.00011173182 -2.6301332f-5 -5.988602f-5 6.904351f-5 -1.980814f-6 0.000116348165 -4.202314f-5 -0.00015434479 0.00011155856 -9.982387f-5 6.260612f-6 -8.2288316f-5 3.8044745f-5 9.262199f-5 4.8014437f-5 -6.399335f-5 5.184394f-5 3.0512085f-6 -0.00014482753; 0.000166463 1.3552729f-5 7.11119f-5 0.00017392857 3.399026f-5 -4.678617f-5 0.00018120716 3.082763f-5 -9.136611f-5 0.00013686728 -0.00013874004 -2.838952f-5 6.949018f-5 1.3243081f-5 -8.588972f-6 -9.313318f-5 -0.00021989715 2.4428367f-5 2.5103334f-5 0.00015883333 0.00024647103 -9.170229f-5 0.00014424197 -0.00013582598 -0.00017463577 -6.201112f-5 7.753022f-5 2.249577f-5 1.9696472f-5 -0.00018065651 8.4762134f-5 -2.166417f-6; 3.7830632f-5 0.000128571 -0.00014404033 -6.52611f-5 8.359899f-5 0.000103959945 7.206748f-5 4.7519086f-5 4.2628042f-5 -2.8785978f-6 -7.827211f-5 -3.3898024f-5 5.9944592f-5 -6.610014f-5 -8.858943f-5 -5.9183505f-5 0.00010882274 2.1937421f-5 1.8951037f-5 2.6048818f-5 0.00015878335 0.00013240769 9.2751376f-5 -9.726772f-5 4.403206f-5 -5.804695f-5 0.00013976639 5.4810775f-5 7.3990166f-5 6.5111024f-5 -3.3257424f-5 1.5969117f-5; -0.000101286016 -0.00010107185 0.00010913507 2.576073f-7 -2.080648f-5 -1.105755f-5 -6.0133738f-5 7.1596056f-5 -2.1448273f-5 6.185803f-5 -4.875936f-6 2.3813653f-5 7.789247f-7 -6.3666506f-5 0.0001326684 -6.3040374f-5 0.00010491733 -6.0462917f-5 -2.5687627f-6 -0.0001109745 0.00020688273 0.00010467681 1.0988284f-5 -2.0410082f-5 1.287381f-5 3.1655574f-5 -6.44576f-5 -5.514708f-5 -3.9077684f-5 1.6548262f-5 6.0883758f-5 0.00018927359; -9.16796f-6 -6.0394592f-5 -7.37737f-5 0.000114427676 -0.00015460915 3.668971f-5 0.00017701603 2.5134666f-5 3.0758572f-5 9.13078f-5 0.00012319749 -4.391893f-5 -8.088577f-5 -8.5429065f-6 -2.726024f-5 -5.0694067f-5 0.00015777769 -7.77088f-5 -0.00011756306 7.2144714f-5 -3.6227106f-5 -1.9374907f-5 3.069758f-5 -7.2919156f-6 6.772582f-5 -0.000110195746 9.7711265f-5 8.626659f-5 -7.785882f-5 0.00026939422 -1.7142458f-5 0.00015961159; 0.00017913067 0.00015167467 1.8951707f-5 -2.3409113f-5 -0.00013066788 4.0908864f-5 -6.340131f-5 0.00014173107 9.441112f-5 -9.894768f-5 -0.00013677691 7.443073f-5 -5.5393652f-6 0.0001925861 5.9535752f-5 -0.00016214825 1.7729337f-5 0.00012716436 3.6447163f-6 7.187831f-5 2.9026209f-5 9.199584f-5 -2.8865798f-5 4.7112324f-5 0.00012319583 7.2061746f-5 -2.0594276f-5 9.961617f-6 -3.0377649f-5 2.0448984f-5 -0.00013198271 -4.40287f-5; -2.4363382f-5 4.502361f-5 5.6052744f-5 -1.2243885f-6 6.402676f-5 -2.6820837f-5 5.957493f-5 -2.6388201f-5 -2.3002687f-5 -8.580241f-5 0.00013400336 6.8813344f-5 -2.3888217f-6 -0.00021755371 0.0001877864 -0.00019983995 6.8375535f-5 1.7200075f-5 -0.00011576389 -4.9204293f-5 2.2305308f-5 1.4658775f-5 -0.00017999235 -4.493279f-5 9.1314374f-5 4.2503565f-5 -2.9290513f-5 -7.792046f-5 -0.000277426 5.4683034f-5 5.2994452f-5 -0.00014084978; -0.00011754237 -2.6985075f-5 0.000110861845 -6.0365153f-5 1.817837f-5 3.335534f-5 6.523836f-5 -8.5755746f-5 -2.1654527f-5 2.4861578f-5 7.3708994f-5 0.00013981877 0.000106053856 1.7308656f-5 -0.00013127593 4.7475634f-5 -0.00016086083 -0.000104395665 5.475023f-6 0.00015984669 -4.2512427f-5 -4.0938708f-6 -0.00013100107 -5.443045f-5 -2.2453907f-5 -0.00011786692 2.9831297f-5 -0.00011127008 0.00015319712 1.7316208f-5 -0.0001152979 -0.00012820508; 8.30176f-5 8.992029f-5 9.596969f-6 -0.00013936604 -4.9803453f-5 -3.1238542f-5 -0.00015881045 7.633006f-5 0.00010559265 -3.8424278f-5 -5.820018f-5 7.258425f-5 -3.6201418f-5 -9.660514f-5 5.362995f-5 -7.232803f-5 3.1190415f-5 -0.00016418034 -0.00010031935 2.0152795f-5 -2.7411828f-5 -1.0545934f-5 -8.136976f-5 5.321489f-5 0.00016503554 -0.00010180804 -3.1243406f-5 1.2585911f-5 -1.9258732f-5 -6.343105f-5 -7.295718f-5 3.5448481f-6; -7.524519f-5 -7.964808f-5 0.00012116242 -0.00015350876 -6.594311f-5 -0.00026031537 -9.68577f-5 6.4919885f-5 0.00015129057 -0.00015650879 -5.1460043f-5 2.9595808f-6 -5.818574f-5 -2.5765114f-5 -0.00015437527 0.00013697203 -4.998498f-5 0.000102023965 0.000107716536 -0.00014365018 -0.00015084405 -1.2654434f-5 -9.111914f-5 -6.9669164f-5 6.702033f-5 8.562706f-5 -0.00010266588 8.119401f-5 -2.9974574f-6 -9.264255f-5 7.877966f-5 -7.113903f-5; -2.7407672f-5 -5.7714773f-5 -1.9615194f-5 0.00017048558 1.283666f-5 -5.5245382f-5 -5.633863f-5 0.0002552813 -0.00012377549 -3.558799f-5 0.000114343005 7.887314f-5 -6.7237284f-5 9.5942225f-5 -9.129473f-7 -0.00010546942 -2.2367898f-5 -6.97105f-5 0.00023304063 0.00012507063 -2.1540432f-6 -0.00014055325 5.7498644f-5 -0.000108718756 -1.3434312f-5 2.0220772f-5 4.3063013f-5 -6.5228676f-5 -0.000111785936 3.805962f-5 1.15555595f-5 -0.0001469137; 7.571296f-5 -9.122261f-6 -1.0507082f-5 -0.00019880096 8.3649815f-5 -0.00010290969 0.00012844532 -1.6490223f-5 -0.00016587967 7.231154f-5 0.00013642499 0.00025883806 -2.9344883f-5 0.00013118029 3.7919108f-5 6.256073f-5 -2.7993307f-5 -7.5869946f-5 -5.0334358f-5 -3.341347f-5 -0.00017581065 0.00014186843 0.0001455443 -0.00011196092 6.694464f-5 -9.549821f-5 -8.375709f-5 8.907147f-7 4.9674883f-5 -9.927414f-6 5.5797966f-5 -7.8824414f-5; 0.00012879641 -3.2307456f-5 -5.3447555f-5 9.280353f-5 -3.2664357f-5 -2.8284043f-5 0.00013664896 8.831541f-6 0.00018565665 -0.00015557536 -3.3195f-6 -2.1624459f-5 -8.488704f-5 -2.1975531f-5 1.704358f-5 -9.758207f-5 1.6185306f-5 -7.929985f-5 -0.0001117032 -0.00016903976 0.00022073089 0.0001563543 0.00033016832 7.737094f-5 0.00014209391 0.00016484722 -4.3611624f-5 9.255428f-5 -9.70487f-5 3.0957133f-5 -2.2754046f-5 -0.0001699819; 7.73544f-6 7.0254f-5 -7.011653f-5 -3.2391967f-5 6.134221f-5 0.00020079047 -0.00018127386 -0.00014314216 -4.9211576f-5 -3.7177182f-5 -4.3750446f-5 -0.00011483024 -0.000107087646 6.881016f-5 0.0001752782 -8.7560744f-5 -7.620473f-5 -7.850121f-5 6.5857334f-6 -0.00010048065 0.00021585485 0.00011902461 3.0282721f-5 1.5329944f-5 0.00011344386 -0.0001477703 -1.6359563f-5 9.58018f-5 2.3715416f-5 0.00012743553 0.00010116716 6.608136f-5; 5.862489f-5 -5.6868525f-6 3.3610762f-5 -1.6544112f-5 -0.00012281933 -5.526257f-6 -8.3166697f-7 -6.886087f-5 -0.000120350494 4.9389197f-5 4.0198834f-6 0.00015178834 -1.360997f-5 7.809813f-5 -0.00010777831 -0.00012392443 3.4336397f-5 0.0002017236 0.00013416377 -6.40155f-5 0.0001467139 -7.9677135f-5 3.848953f-5 4.9872877f-5 0.00018720208 2.6777876f-5 -8.558532f-6 4.2625918f-5 -1.0655224f-5 5.6039913f-5 8.2148086f-5 0.00011599458; 4.781994f-5 -8.607178f-6 -6.322948f-6 3.061703f-5 6.708142f-5 -2.535718f-5 1.8356057f-5 0.00022099151 -2.0176338f-5 -8.966473f-5 -6.218352f-5 -5.8440437f-5 3.0422776f-5 -6.869571f-5 2.1265827f-5 -0.0001752914 2.8623734f-5 -0.00014952231 4.691095f-5 6.831469f-5 1.1455243f-5 -5.9320413f-5 -6.628469f-5 3.3439414f-5 -1.8330775f-5 -2.5715632f-5 -9.009364f-5 5.2168336f-5 -5.589949f-5 5.516548f-5 -0.00012844498 -6.606958f-5; 4.4887573f-5 8.070057f-5 0.00013770907 4.4663782f-5 -1.2535162f-5 -7.0130377f-6 -2.595881f-5 -1.7425082f-5 6.130283f-5 -1.6853544f-5 5.234941f-6 1.8505075f-6 -8.804992f-5 -0.00011993626 2.974827f-5 5.6475055f-5 -4.0024566f-5 0.00011133209 -2.430998f-5 -9.308676f-5 -0.00016539948 -0.00023895128 4.7653775f-5 1.8219202f-5 1.9725996f-5 -0.00014566167 4.369429f-5 3.55035f-6 1.7020036f-6 2.683044f-5 -8.4810075f-5 2.971891f-5; -3.200572f-5 -5.3874322f-5 3.9665578f-5 2.0178715f-5 3.3949203f-5 3.8885533f-5 -4.59938f-5 0.00010939176 -1.7613515f-5 -5.1740815f-5 0.00019039224 4.0309682f-5 1.9456056f-5 0.00021376098 -0.00015797002 7.1154616f-5 2.9931596f-5 0.00012672685 3.570883f-5 -0.00020102883 -8.689764f-5 -7.601622f-5 -9.895334f-5 -0.0001639613 0.00019455113 -0.00019172434 0.0001382529 -2.208884f-5 -3.247524f-5 -5.2923115f-5 0.00022493894 3.755611f-5; 9.802766f-5 0.00012522638 7.929207f-5 -0.0001115388 -0.00010278748 0.00014889923 -0.00025354075 0.000117932905 -0.00019697961 -0.00015087472 -8.774156f-5 -1.9782061f-5 3.8007904f-5 5.640147f-5 -5.0013325f-5 -5.3318992f-5 -0.00014511544 -7.9914964f-5 2.3220678f-5 -1.2824187f-5 1.5783167f-5 0.0002010304 -6.5437824f-5 5.10959f-5 7.690405f-5 0.00017971211 -8.0330006f-5 4.2255357f-5 -6.331249f-5 -0.00017205585 -0.00012285644 -9.844745f-5; -3.2024906f-5 3.0817882f-5 0.00013189709 -4.7218156f-5 -7.849702f-5 -8.421266f-5 6.832911f-5 5.0903996f-5 4.701058f-5 1.6055588f-5 -6.101991f-5 -0.00013207165 0.00013462639 8.0793594f-5 -2.027767f-6 -0.00014131988 2.5230222f-5 0.00010510108 0.0001454994 6.5236563f-6 4.2398533f-5 -5.054146f-5 2.6644157f-6 -4.8891077f-5 -1.5756782f-6 -2.4347777f-5 -4.9713122f-5 5.675292f-5 -9.798052f-5 -0.00012336597 1.3146233f-5 9.5669915f-5; 1.2607205f-5 -5.402204f-5 6.7741006f-5 3.715613f-6 -5.4236916f-5 -3.1204032f-5 4.4866887f-5 -0.00015785315 8.237487f-5 9.852471f-5 -3.649373f-5 0.000120730314 0.000104991865 0.00012251092 -1.8877116f-5 -3.0262981f-5 -0.00011801242 -3.416006f-5 0.00015336962 1.5456275f-5 6.7720107f-6 2.3209535f-5 -3.4880362f-5 6.1925f-6 -6.0519502f-5 -7.1400704f-5 0.00012734304 -2.496367f-6 -6.830043f-5 4.0758256f-5 -3.454284f-5 0.00020905262; 0.00011081468 4.4577002f-5 5.9049344f-5 1.0499451f-5 -8.3444065f-5 0.00016487188 -0.00011388294 -8.318422f-5 4.7835354f-5 -6.072508f-5 8.501881f-5 9.714187f-5 -2.5633144f-5 5.7533405f-5 4.7621845f-5 4.7267163f-6 -0.0001187756 9.230583f-5 9.6501884f-5 -9.7026066f-5 0.00010362341 9.436298f-5 -1.6172802f-5 -8.797193f-5 -7.0864095f-5 -8.1977654f-5 -8.020823f-5 2.2692043f-6 3.651337f-5 4.8447186f-5 -3.8978884f-5 7.105116f-5], bias = Float32[0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0;;]), layer_4 = (weight = Float32[0.00021701695 1.2129347f-5 -0.0001200642 6.136064f-5 0.000110476954 -6.759561f-5 0.00019215174 0.00026349013 -2.3253711f-5 -3.5156863f-5 -5.199456f-5 -7.369296f-5 0.00015433249 -9.5950796f-5 -0.000120019424 -0.00010542603 -6.2809995f-5 6.7821165f-5 -7.088361f-5 9.343306f-6 -0.00016852275 -1.7849554f-5 -0.000119891614 0.0001772828 0.00014741342 0.00017697124 0.00017988 -2.8678f-5 3.976478f-5 -9.251292f-5 -0.00010116626 5.9656057f-5; -8.331487f-5 0.00012086859 0.00012186931 0.00030700423 1.4121894f-5 9.9910656f-5 -3.565087f-5 9.553726f-5 -1.1312654f-5 -1.65502f-5 -2.6185939f-5 1.2905688f-5 0.00016300903 7.274908f-5 1.5736061f-5 -3.460863f-5 -0.00011962608 -0.00023554012 2.0317797f-5 7.2315066f-5 -6.853772f-5 -3.5572393f-5 7.9988145f-5 7.365756f-5 2.1507718f-5 5.9364134f-5 0.00011565546 7.886633f-5 -9.787369f-6 5.2306877f-5 5.9771446f-5 -4.7303223f-5], bias = Float32[0.0; 0.0;;])), (layer_1 = NamedTuple(), layer_2 = NamedTuple(), layer_3 = NamedTuple(), layer_4 = NamedTuple()))
```


Similar to most DL frameworks, Lux defaults to using `Float32`, however, in this case we need Float64


```julia
const params = ComponentArray{Float64}(ps)
```


```
ComponentVector{Float64}(layer_1 = Float64[], layer_2 = (weight = [-0.00012616052117664367; 0.00014660763554275036; 0.00015070995141286403; 2.203571784775704e-5; -8.254036220023409e-5; 1.8704853573581204e-5; -1.595041248947382e-5; 9.260340448236093e-5; -3.573838694137521e-5; -1.1666958016576245e-5; 6.125606887508184e-5; 2.1726267732447013e-5; 8.564301970181987e-5; 8.64037974679377e-6; 4.144657214055769e-5; -0.00010806799400597811; -8.746889761823695e-6; 1.6406022041337565e-5; -3.2490454032085836e-5; -8.893241465557367e-5; -1.8538392396294512e-5; 0.00019251875346526504; -1.4560135241481476e-5; 8.841512317303568e-5; -6.717799988109618e-5; -5.7206118071917444e-5; 0.0001704804744804278; -0.00012598338071256876; -3.832865331787616e-5; 0.00010855933942366391; 1.1100784831796773e-5; 4.470951171242632e-5;;], bias = [0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0;;]), layer_3 = (weight = [-6.96133793098852e-5 -9.444449096918106e-5 -0.00021123407350387424 -0.00010737884440459311 -0.0001313452812610194 8.142564911395311e-5 0.00011715379514498636 -0.0001464446831960231 7.067113619996235e-5 0.0001507894485257566 5.406934360507876e-5 8.143048944475595e-6 -0.0002522332360967994 -3.0272023650468327e-5 0.00026090926257893443 -3.817461220023688e-6 -1.1114494554931298e-5 -0.00010230722546111792 7.433372229570523e-5 -3.26737790601328e-5 -1.3983770259073935e-5 9.150173718808219e-5 -3.32774143316783e-5 -1.8748673028312624e-5 -8.490207983413711e-5 6.574135477421805e-5 -1.3444262549455743e-5 -0.0001224498701049015 9.098869486479089e-5 -7.140811067074537e-5 1.4249098967411555e-6 2.4913788365665823e-5; -4.0201419324148446e-5 -5.8570149121806026e-5 -1.5645064195268787e-5 2.4619195755803958e-5 1.2039015928166918e-5 0.00013975788897369057 -3.347000165376812e-5 -1.4211989764589816e-5 -4.053052543895319e-5 0.00016616361972410232 -6.838252011220902e-5 8.736297604627907e-5 -2.774991480691824e-5 0.0002081446145894006 -0.00015251054719556123 -3.834936433122493e-5 0.00021629504044540226 0.00015427087782882154 0.00016896809393074363 4.015594095108099e-5 4.875098511547549e-6 -6.547502562170848e-5 0.00011489624012028798 3.263885810156353e-5 3.1330030196841108e-6 -4.027050090371631e-5 -5.465038339025341e-5 -0.00015303607506211847 7.476818427676335e-5 -2.801154914777726e-5 0.0001631484046811238 0.00012176933523733169; -1.8749495211523026e-5 6.509529339382425e-5 9.099045564653352e-5 -2.9979037208249792e-5 7.892123539932072e-5 -4.045449895784259e-5 -4.690247806138359e-5 2.851342287613079e-5 0.0001961103844223544 8.98893631529063e-5 -7.668827311135828e-5 7.665669727430213e-6 -8.27751646284014e-5 4.469901250558905e-5 8.120576967485249e-5 5.388195859268308e-5 3.061492407141486e-6 -9.146867523668334e-5 -7.148864096961915e-5 -0.00011565569002414122 0.00014613315579481423 -1.8123600966646336e-5 0.00011429125879658386 -9.07033754629083e-5 -8.051560143940151e-5 3.0780847737332806e-5 3.098146044067107e-5 4.7025398089317605e-5 -0.0001306088815908879 -4.643943611881696e-5 0.00011527298192959279 -2.3982667698874138e-5; 1.049836919264635e-5 -7.973966421559453e-5 -1.9286312635813374e-6 0.0001575664064148441 2.669961759238504e-5 2.784855678328313e-5 -0.00015111501852516085 1.2828796570829581e-5 1.5196018466667738e-5 -0.00010777425632113591 -0.0001710178767098114 0.00017029444279614836 -0.00011018768418580294 -6.53704337310046e-5 2.29343022510875e-5 -4.094012183486484e-5 -0.0003472963289823383 -1.7188400306622498e-5 9.707325261842925e-6 9.148974640993401e-5 5.8802190324058756e-5 -2.1607212374874507e-7 -4.508790516410954e-5 -8.702045306563377e-5 -0.0001670884812483564 5.146997136762366e-5 0.0001544451661175117 6.498700531665236e-5 0.00014326345990411937 -2.12844923908051e-7 8.953696669777855e-5 -1.897577203635592e-5; 0.00011007929424522445 6.585255323443562e-5 -9.079697338165715e-5 2.7317895728629082e-5 0.0001982906978810206 -0.00026708803488872945 3.791708513745107e-5 4.121504389331676e-6 8.38916894281283e-5 4.4280270230956376e-5 7.92793434811756e-5 0.00010952269076369703 2.0497134755714796e-5 -0.00010757450218079612 -3.964996722061187e-5 -0.00022113393060863018 -0.00015360445831902325 1.0366774404246826e-5 -0.00018248277774546295 -6.443075108109042e-5 -3.4984734611498425e-6 0.00015199925110209733 8.808013080852106e-5 -0.00010862394265132025 0.0001683520240476355 -0.0001983665133593604 6.112206028774381e-5 0.00012663645611610264 0.00012854854867327958 2.7776746719609946e-5 -3.6185978387948126e-5 -0.00018064597679767758; 1.6459751350339502e-5 7.018815813353285e-5 8.322874055011198e-5 3.664851465146057e-5 -0.00017313557327724993 -5.843125836690888e-5 -3.316061565783457e-6 -0.000174855871591717 -4.7157769586192444e-5 -8.354263991350308e-5 -1.0368306902819313e-5 -0.00017702461627777666 5.6849898101063445e-5 -6.987866072449833e-5 -4.196325608063489e-5 0.0002728357503656298 0.00010129550355486572 1.798000084818341e-5 -0.0002061777631752193 -9.359652176499367e-5 0.00019265715673100203 5.592555316979997e-5 6.921814201632515e-5 6.983967614360154e-5 -7.471109711332247e-5 -0.00014529965119436383 0.00014868626021780074 -0.00013022190250921994 -1.3311723705555778e-5 -0.00010050213313661516 0.00016196917567867786 -2.988634878420271e-5; 4.21556323999539e-5 5.403635441325605e-5 5.92936557950452e-5 7.729433855274692e-5 -1.2435439202818088e-6 0.00019128795247524977 -0.00018354476196691394 0.0001666917814873159 1.545866507512983e-5 4.168780651525594e-5 -1.4922900845704135e-5 2.414510709058959e-5 -0.00011565224849618971 -2.5778674171306193e-5 0.00012109309318475425 -0.00011374365567462519 -7.512752927141264e-5 -0.0002031428593909368 -1.8225551684736274e-5 -4.578523657983169e-6 1.4903170267643873e-5 -2.359895188419614e-5 -3.084060153923929e-5 -4.670920316129923e-5 0.00010880539775826037 7.992598693817854e-5 -9.406555909663439e-5 3.7295776564860716e-5 0.0001728170464048162 6.120045873103663e-5 -5.720587068935856e-5 7.545697735622525e-5; -5.5590866395505145e-5 -2.6506875656195916e-5 -0.0001415825099684298 2.2283007638179697e-5 4.443801117304247e-6 -0.0001605040015419945 3.590460619307123e-5 -1.7574366211192682e-5 0.00010649261821527034 2.8244981876923703e-5 7.647373422514647e-5 -4.556766361929476e-5 2.2080816052039154e-5 8.635350241092965e-5 0.0001111950259655714 1.6960635548457503e-5 0.00019514166342560202 -5.717947715311311e-5 -0.0001345134078292176 -5.359503484214656e-5 0.0001313003449467942 -6.449034799516085e-7 9.527813381282613e-5 4.544524199445732e-5 -9.691113518783823e-6 -8.11799691291526e-5 -0.00019435935246292502 0.00013634773495141417 0.00016174084157682955 3.594212103052996e-5 -2.9692553653148934e-5 1.623344542167615e-5; -4.032198717141e-7 4.657644240069203e-5 5.9333771787351e-5 -6.097132427385077e-5 -0.00013120919174980372 -2.682108424778562e-5 -1.7904327251017094e-5 3.848291271424387e-6 -0.00013149403093848377 2.2982862901699264e-6 0.00012818937830161303 4.7644469304941595e-5 1.7082631529774517e-5 -7.062373333610594e-5 -3.0964030884206295e-5 0.0002100381243508309 -0.00016579953080508858 -0.00010996386117767543 -4.1385068470845e-5 -9.792731725610793e-5 3.9447790186386555e-5 0.0001377407752443105 0.00010113276948686689 -8.536880341125652e-5 -6.362311250995845e-5 0.00015276591875590384 -8.801637886790559e-5 -4.976415220880881e-5 -5.938694448559545e-5 1.5414787412737496e-5 8.959087426774204e-5 -6.487004156952025e-6; -6.382889114320278e-5 1.3811642929795198e-5 -1.0402165571576916e-5 0.00010136001219507307 -8.931068441597745e-5 -7.286712934728712e-5 3.4014290577033535e-5 -6.724605191266164e-5 -6.19333004578948e-5 4.107256609131582e-5 7.167615694925189e-5 7.670788181712851e-5 -5.27165593666723e-6 2.7907082767342217e-5 -8.666319627081975e-5 -1.1364261808921583e-5 2.388373331996263e-6 3.3742006053216755e-5 1.852155037340708e-5 6.889920769026503e-5 -4.6370052587008104e-5 -5.208358561503701e-5 -8.68283532327041e-5 -2.1218302208581008e-5 -6.059082443243824e-5 8.727158274268731e-5 7.03411060385406e-5 0.00022608366271015257 -2.7800288080470636e-5 -4.181075200904161e-5 -6.555757863679901e-5 3.823518272838555e-5; 8.548487676307559e-5 -4.231848652125336e-5 -5.165706897969358e-5 -0.0001765830529620871 -7.150067631300772e-7 1.667468859523069e-5 -5.312289431458339e-5 -3.490433664410375e-5 -2.7639844120130874e-5 3.000726064783521e-5 3.0861283448757604e-5 -5.492963828146458e-5 0.00011665710189845413 -0.0001117318170145154 -2.6301331672584638e-5 -5.9886020608246326e-5 6.904351175762713e-5 -1.98081397684291e-6 0.0001163481647381559 -4.202314084977843e-5 -0.00015434478700626642 0.00011155856191180646 -9.982386836782098e-5 6.260611826292006e-6 -8.228831575252116e-5 3.804474545177072e-5 9.262198727810755e-5 4.8014437197707593e-5 -6.399334961315617e-5 5.184394103707746e-5 3.0512085231748642e-6 -0.0001448275288566947; 0.0001664629962760955 1.3552728887589183e-5 7.111189916031435e-5 0.00017392856534570456 3.3990261727012694e-5 -4.678616824094206e-5 0.00018120715685654432 3.08276285068132e-5 -9.136611333815381e-5 0.00013686728198081255 -0.00013874004071112722 -2.838952059391886e-5 6.949018279556185e-5 1.324308141192887e-5 -8.588972377765458e-6 -9.313318150816485e-5 -0.00021989714878145605 2.4428367396467365e-5 2.5103334337472916e-5 0.00015883332525845617 0.0002464710269123316 -9.170229168375954e-5 0.00014424197433982044 -0.00013582597603090107 -0.00017463577387388796 -6.20111168245785e-5 7.753021782264113e-5 2.2495769371744245e-5 1.969647200894542e-5 -0.00018065651238430291 8.476213406538591e-5 -2.1664170617441414e-6; 3.783063220907934e-5 0.00012857100227847695 -0.00014404032845050097 -6.526109791593626e-5 8.359899220522493e-5 0.00010395994468126446 7.206747977761552e-5 4.751908636535518e-5 4.2628042137948796e-5 -2.8785977974621346e-6 -7.827211084077135e-5 -3.389802441233769e-5 5.99445920670405e-5 -6.610013952013105e-5 -8.858943328959867e-5 -5.9183505072724074e-5 0.00010882273636525497 2.1937421479378827e-5 1.8951037418446504e-5 2.6048817744595e-5 0.00015878335398156196 0.00013240768748801202 9.275137563236058e-5 -9.726772259455174e-5 4.403205821290612e-5 -5.8046949561685324e-5 0.00013976638729218394 5.481077459990047e-5 7.399016612907872e-5 6.511102401418611e-5 -3.325742363813333e-5 1.5969117157510482e-5; -0.00010128601570613682 -0.00010107184789376333 0.00010913507139775902 2.5760729727153375e-7 -2.080647936963942e-5 -1.1057550182158593e-5 -6.0133737861178815e-5 7.159605593187734e-5 -2.1448273400892504e-5 6.185803067637607e-5 -4.8759361561678816e-6 2.3813652660464868e-5 7.789246865286259e-7 -6.366650632116944e-5 0.00013266839960124344 -6.304037378868088e-5 0.00010491732973605394 -6.04629167355597e-5 -2.568762738519581e-6 -0.00011097449896624312 0.00020688273070845753 0.00010467680840520188 1.0988283975166269e-5 -2.04100815608399e-5 1.2873810192104429e-5 3.165557427564636e-5 -6.445759936468676e-5 -5.514708027476445e-5 -3.907768405042589e-5 1.654826155572664e-5 6.088375812396407e-5 0.00018927358905784786; -9.167960342892911e-6 -6.039459185558371e-5 -7.377369911409914e-5 0.00011442767572589219 -0.00015460915165022016 3.668971112347208e-5 0.00017701603064779192 2.5134666429948993e-5 3.0758572393096983e-5 9.130779653787613e-5 0.00012319748930167407 -4.39189316239208e-5 -8.08857730589807e-5 -8.54290647112066e-6 -2.726023922150489e-5 -5.0694066885625944e-5 0.00015777768567204475 -7.770879892632365e-5 -0.00011756306048482656 7.214471406769007e-5 -3.62271057383623e-5 -1.9374907424207777e-5 3.069758167839609e-5 -7.291915608220734e-6 6.772582128178328e-5 -0.00011019574594683945 9.771126497071236e-5 8.626659109722823e-5 -7.78588218963705e-5 0.00026939422241412103 -1.714245809125714e-5 0.0001596115907886997; 0.0001791306713130325 0.0001516746706329286 1.895170680654701e-5 -2.3409113055095077e-5 -0.0001306678750552237 4.090886432095431e-5 -6.340131221804768e-5 0.0001417310704709962 9.441112342756242e-5 -9.894768300000578e-5 -0.0001367769145872444 7.443073263857514e-5 -5.5393652473867405e-6 0.00019258609972894192 5.953575237072073e-5 -0.00016214825154747814 1.7729336832417175e-5 0.0001271643559448421 3.644716343842447e-6 7.187831215560436e-5 2.902620872191619e-5 9.199584019370377e-5 -2.8865797503385693e-5 4.7112323954934254e-5 0.00012319583038333803 7.206174632301554e-5 -2.059427606582176e-5 9.96161725197453e-6 -3.0377648727153428e-5 2.0448984287213534e-5 -0.0001319827133556828 -4.4028700358467177e-5; -2.4363382181036286e-5 4.502361116465181e-5 5.605274418485351e-5 -1.2243884839335806e-6 6.40267608105205e-5 -2.6820836865226738e-5 5.95749297644943e-5 -2.6388201149529777e-5 -2.3002687157713808e-5 -8.580240682931617e-5 0.00013400336320046335 6.881334411446005e-5 -2.388821712884237e-6 -0.00021755370835307986 0.000187786397873424 -0.00019983995298389345 6.83755351928994e-5 1.7200074580614455e-5 -0.00011576389078982174 -4.9204292736249045e-5 2.230530844826717e-5 1.465877539885696e-5 -0.00017999234842136502 -4.4932789023732767e-5 9.131437400355935e-5 4.2503565055085346e-5 -2.9290513339219615e-5 -7.792045653332025e-5 -0.00027742600650526583 5.468303425004706e-5 5.299445183482021e-5 -0.00014084977738093585; -0.00011754236766137183 -2.6985075237462297e-5 0.00011086184531450272 -6.0365153331076726e-5 1.8178370737587102e-5 3.3355339837726206e-5 6.523836054839194e-5 -8.575574611313641e-5 -2.1654526790371165e-5 2.4861577912815847e-5 7.370899402303621e-5 0.00013981877418700606 0.00010605385614326224 1.7308655515080318e-5 -0.000131275926833041 4.7475634346483275e-5 -0.0001608608290553093 -0.00010439566540298983 5.475023044709815e-6 0.00015984669153112918 -4.251242717145942e-5 -4.093870757060358e-6 -0.00013100107025820762 -5.443044938147068e-5 -2.245390714961104e-5 -0.00011786691902671009 2.9831297069904394e-5 -0.0001112700774683617 0.0001531971211079508 1.731620795908384e-5 -0.00011529790208442137 -0.00012820507981814444; 8.301759953610599e-5 8.992029324872419e-5 9.596968993719202e-6 -0.0001393660350004211 -4.980345329386182e-5 -3.1238541851053014e-5 -0.00015881044964771718 7.63300631660968e-5 0.00010559264774201438 -3.8424277590820566e-5 -5.820018122904003e-5 7.258424739120528e-5 -3.620141797000542e-5 -9.660513751441613e-5 5.362994852475822e-5 -7.232803181977943e-5 3.1190415029414e-5 -0.0001641803391976282 -0.00010031934652943164 2.0152794604655355e-5 -2.741182834142819e-5 -1.0545933946559671e-5 -8.136976248351857e-5 5.3214891522657126e-5 0.0001650355407036841 -0.00010180803656112403 -3.1243405828718096e-5 1.258591055375291e-5 -1.925873220898211e-5 -6.343104905681685e-5 -7.295717659872025e-5 3.544848141245893e-6; -7.52451887819916e-5 -7.96480817371048e-5 0.00012116241850890219 -0.0001535087649244815 -6.594310980290174e-5 -0.0002603153698146343 -9.685770055511966e-5 6.491988460766152e-5 0.00015129057283047587 -0.00015650878776796162 -5.1460043323459104e-5 2.9595807973237243e-6 -5.818573845317587e-5 -2.576511360530276e-5 -0.00015437527326866984 0.00013697202666662633 -4.9984981160378084e-5 0.00010202396515524015 0.00010771653614938259 -0.00014365017705131322 -0.00015084404731169343 -1.2654433703573886e-5 -9.111913823289797e-5 -6.966916407691315e-5 6.702032987959683e-5 8.562706352677196e-5 -0.00010266587923979387 8.119401172734797e-5 -2.997457386300084e-6 -9.264254913432524e-5 7.877965981606394e-5 -7.113903120625764e-5; -2.7407671950641088e-5 -5.7714772992767394e-5 -1.961519410542678e-5 0.00017048558220267296 1.283666006202111e-5 -5.5245382100110874e-5 -5.6338631111430004e-5 0.00025528130936436355 -0.0001237754913745448 -3.558798925951123e-5 0.00011434300540713593 7.887314131949097e-5 -6.723728438373655e-5 9.594222501618788e-5 -9.129473141911149e-7 -0.00010546942212386057 -2.236789805465378e-5 -6.971049879211932e-5 0.00023304062779061496 0.00012507062638178468 -2.1540431589528453e-6 -0.00014055325300432742 5.749864430981688e-5 -0.00010871875565499067 -1.3434311767923646e-5 2.0220772057655267e-5 4.306301343603991e-5 -6.522867624880746e-5 -0.0001117859355872497 3.805962114711292e-5 1.155555946752429e-5 -0.0001469137059757486; 7.571296009700745e-5 -9.122260962612927e-6 -1.0507082151889335e-5 -0.0001988009607885033 8.364981476916e-5 -0.00010290968930348754 0.00012844531738664955 -1.6490223060827702e-5 -0.0001658796682022512 7.231153722386807e-5 0.00013642499106936157 0.0002588380593806505 -2.93448829324916e-5 0.00013118029164616019 3.791910785366781e-5 6.256072811083868e-5 -2.7993306503049098e-5 -7.586994615849108e-5 -5.033435809309594e-5 -3.3413471101084724e-5 -0.0001758106518536806 0.00014186842599883676 0.00014554429799318314 -0.00011196092236787081 6.694463809253648e-5 -9.549820970278233e-5 -8.375709148822352e-5 8.907147162062756e-7 4.967488348484039e-5 -9.927413884724956e-6 5.5797965615056455e-5 -7.882441423134878e-5; 0.00012879641144536436 -3.230745642213151e-5 -5.344755481928587e-5 9.280352969653904e-5 -3.2664356695022434e-5 -2.8284042855375446e-5 0.00013664895959664136 8.83154098119121e-6 0.00018565665232017636 -0.00015557535516563803 -3.3194999105035095e-6 -2.162445889553055e-5 -8.48870404297486e-5 -2.1975531126372516e-5 1.704357964626979e-5 -9.758207306731492e-5 1.618530586711131e-5 -7.929984712973237e-5 -0.00011170320067321882 -0.00016903976211324334 0.0002207308862125501 0.00015635430463589728 0.00033016831730492413 7.737093983450904e-5 0.0001420939079253003 0.0001648472243687138 -4.361162427812815e-5 9.255427721654996e-5 -9.704870171844959e-5 3.095713327638805e-5 -2.2754045858164318e-5 -0.0001699818967608735; 7.73543979448732e-6 7.02539982739836e-5 -7.011653360677883e-5 -3.239196666982025e-5 6.134220893727615e-5 0.00020079046953469515 -0.00018127386283595115 -0.0001431421551387757 -4.921157596982084e-5 -3.7177182093728334e-5 -4.375044591142796e-5 -0.00011483023990876973 -0.00010708764602895826 6.881015724502504e-5 0.00017527819727547467 -8.756074385019019e-5 -7.620472752023488e-5 -7.850120891816914e-5 6.585733444808284e-6 -0.00010048064723378047 0.00021585484500974417 0.00011902461119461805 3.028272112715058e-5 1.5329944289987907e-5 0.00011344385711709037 -0.0001477703044656664 -1.63595632329816e-5 9.580179903423414e-5 2.371541631873697e-5 0.00012743553088512272 0.00010116716293850914 6.608136027352884e-5; 5.8624889788916335e-5 -5.686852546205046e-6 3.3610762329772115e-5 -1.6544112440897152e-5 -0.0001228193286806345 -5.526257154997438e-6 -8.316669664054643e-7 -6.88608706695959e-5 -0.00012035049439873546 4.938919664709829e-5 4.019883363071131e-6 0.00015178833564277738 -1.3609969755634665e-5 7.809812814230099e-5 -0.00010777830902952701 -0.00012392443022690713 3.4336397220613435e-5 0.00020172359654679894 0.00013416376896202564 -6.401549762813374e-5 0.0001467138936277479 -7.967713463585824e-5 3.848952837870456e-5 4.987287684343755e-5 0.00018720208026934415 2.6777875973493792e-5 -8.558531590097118e-6 4.2625917558325455e-5 -1.0655224286892917e-5 5.6039913033600897e-5 8.2148086221423e-5 0.00011599458230193704; 4.781993993674405e-5 -8.607177733210847e-6 -6.322948138404172e-6 3.0617029551649466e-5 6.708141881972551e-5 -2.535717976570595e-5 1.8356056898483075e-5 0.00022099151101429015 -2.017633778450545e-5 -8.966473251348361e-5 -6.218352064024657e-5 -5.844043698743917e-5 3.0422776035265997e-5 -6.869570643175393e-5 2.126582694472745e-5 -0.0001752913958625868 2.8623733669519424e-5 -0.0001495223114034161 4.691095091402531e-5 6.83146936353296e-5 1.1455243111413438e-5 -5.9320413129171357e-5 -6.62846869090572e-5 3.3439413527958095e-5 -1.833077476476319e-5 -2.57156316365581e-5 -9.009364293888211e-5 5.216833596932702e-5 -5.5899490689625964e-5 5.516548117157072e-5 -0.0001284449826925993 -6.606958049815148e-5; 4.4887572585139424e-5 8.070057083386928e-5 0.0001377090666210279 4.466378231882118e-5 -1.2535161658888683e-5 -7.013037702563452e-6 -2.5958810510928743e-5 -1.7425081750843674e-5 6.13028314546682e-5 -1.6853544366313145e-5 5.2349409997987095e-6 1.8505074876884464e-6 -8.804992103250697e-5 -0.00011993625957984477 2.9748269298579544e-5 5.6475055316695943e-5 -4.00245662603993e-5 0.00011133209045510739 -2.4309980290126987e-5 -9.308676089858636e-5 -0.00016539948410354555 -0.00023895128106232733 4.7653775254730135e-5 1.8219201592728496e-5 1.9725996025954373e-5 -0.00014566167374141514 4.369429007056169e-5 3.550349902070593e-6 1.7020036011672346e-6 2.6830439310288057e-5 -8.481007535010576e-5 2.9718910809606314e-5; -3.2005718821892515e-5 -5.387432247516699e-5 3.96655777876731e-5 2.0178715203655884e-5 3.394920349819586e-5 3.888553328579292e-5 -4.599379826686345e-5 0.0001093917599064298 -1.7613514501135796e-5 -5.174081525183283e-5 0.0001903922384371981 4.030968193546869e-5 1.9456056179478765e-5 0.0002137609844794497 -0.00015797001833561808 7.115461630746722e-5 2.9931596145615913e-5 0.00012672685261350125 3.570882836356759e-5 -0.0002010288299061358 -8.689764217706397e-5 -7.601622201036662e-5 -9.8953336419072e-5 -0.00016396130376961082 0.00019455113215371966 -0.00019172433530911803 0.0001382529007969424 -2.2088839614298195e-5 -3.247524000471458e-5 -5.292311470839195e-5 0.0002249389362987131 3.75561103282962e-5; 9.802765998756513e-5 0.0001252263755304739 7.929206913104281e-5 -0.00011153880041092634 -0.00010278748231939971 0.00014889922749716789 -0.0002535407547838986 0.00011793290468631312 -0.00019697961397469044 -0.00015087472274899483 -8.774155867286026e-5 -1.9782060917350464e-5 3.8007903640391305e-5 5.64014699193649e-5 -5.0013324653264135e-5 -5.3318992286222056e-5 -0.00014511543849948794 -7.991496386239305e-5 2.322067848581355e-5 -1.2824187251680996e-5 1.57831673277542e-5 0.00020103040151298046 -6.543782365042716e-5 5.109589983476326e-5 7.690404891036451e-5 0.00017971210763789713 -8.033000631257892e-5 4.22553566750139e-5 -6.331248732749373e-5 -0.00017205585027113557 -0.00012285643606446683 -9.844744636211544e-5; -3.2024905522121117e-5 3.0817882361589e-5 0.00013189708988647908 -4.721815639641136e-5 -7.849701796658337e-5 -8.421266102232039e-5 6.83291073073633e-5 5.090399645268917e-5 4.701058060163632e-5 1.6055588275776245e-5 -6.101990948081948e-5 -0.00013207165466155857 0.00013462638889905065 8.079359395196661e-5 -2.0277670955692884e-6 -0.00014131987700238824 2.5230221581296064e-5 0.00010510107676964253 0.00014549940533470362 6.5236563386861235e-6 4.23985329689458e-5 -5.054146095062606e-5 2.6644156605470926e-6 -4.8891077312873676e-5 -1.5756781976961065e-6 -2.4347777070943266e-5 -4.9713122280081734e-5 5.67529205000028e-5 -9.798051905818284e-5 -0.0001233659713761881 1.3146232959115878e-5 9.566991502651945e-5; 1.260720455320552e-5 -5.402203896665014e-5 6.774100620532408e-5 3.7156130474613747e-6 -5.4236916184891015e-5 -3.120403198408894e-5 4.48668870376423e-5 -0.00015785315190441906 8.237487054429948e-5 9.852470975602046e-5 -3.649372956715524e-5 0.00012073031393811107 0.00010499186464585364 0.0001225109153892845 -1.8877115508075804e-5 -3.02629814541433e-5 -0.00011801242362707853 -3.416006074985489e-5 0.00015336961951106787 1.545627492305357e-5 6.772010692657204e-6 2.320953535672743e-5 -3.4880362363765016e-5 6.192500222823583e-6 -6.0519501857925206e-5 -7.140070374589413e-5 0.00012734303891193122 -2.496366960258456e-6 -6.83004327584058e-5 4.075825563631952e-5 -3.454284160397947e-5 0.00020905262499582022; 0.00011081468255724758 4.457700197235681e-5 5.9049343690276146e-5 1.0499450581846759e-5 -8.344406523974612e-5 0.00016487187531311065 -0.0001138829393312335 -8.318421896547079e-5 4.78353540529497e-5 -6.072508040233515e-5 8.501880802214146e-5 9.714187035569921e-5 -2.5633144105086103e-5 5.753340519731864e-5 4.762184471474029e-5 4.726716269942699e-6 -0.00011877559882123023 9.230583236785606e-5 9.650188439991325e-5 -9.702606621431187e-5 0.00010362340981373563 9.436297841602936e-5 -1.6172802133951336e-5 -8.797193004284054e-5 -7.086409459589049e-5 -8.197765419026837e-5 -8.020822860999033e-5 2.269204287586035e-6 3.651337101473473e-5 4.8447185690747574e-5 -3.897888382198289e-5 7.105115946615115e-5], bias = [0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0;;]), layer_4 = (weight = [0.00021701694640796632 1.2129346941947006e-5 -0.00012006420001853257 6.136063893791288e-5 0.00011047695443267003 -6.759561074431986e-5 0.0001921517396112904 0.00026349013205617666 -2.3253711333381943e-5 -3.5156863305019215e-5 -5.199456063564867e-5 -7.369295781245455e-5 0.00015433249063789845 -9.595079609425738e-5 -0.00012001942377537489 -0.00010542602831264958 -6.280999514274299e-5 6.782116543035954e-5 -7.088360871421173e-5 9.343306373921223e-6 -0.0001685227471170947 -1.784955384209752e-5 -0.00011989161430392414 0.00017728279635775834 0.00014741341874469072 0.000176971239852719 0.0001798799930838868 -2.8677999580395408e-5 3.976477819378488e-5 -9.251292067347094e-5 -0.00010116626071976498 5.9656056691892445e-5; -8.331487333634868e-5 0.00012086859351256862 0.00012186930689495057 0.0003070042293984443 1.4121894309937488e-5 9.991065599024296e-5 -3.565087172319181e-5 9.553725976729766e-5 -1.1312654351058882e-5 -1.655020059843082e-5 -2.6185938622802496e-5 1.290568798140157e-5 0.0001630090264370665 7.274907693499699e-5 1.5736060959170572e-5 -3.4608630812726915e-5 -0.00011962607823079452 -0.00023554012295790017 2.0317796952440403e-5 7.231506606331095e-5 -6.853772356407717e-5 -3.557239324436523e-5 7.998814544407651e-5 7.365756027866155e-5 2.1507717974600382e-5 5.9364134358474985e-5 0.00011565545719349757 7.88663310231641e-5 -9.787368981051259e-6 5.2306877478258684e-5 5.977144610369578e-5 -4.7303223254857585e-5], bias = [0.0; 0.0;;]))
```


Now we define a system of odes which describes motion of point like particle with Newtonian physics, uses


$$
u[1] = \chi
$$


$$
u[2] = \phi
$$


where, $p$, $M$, and $e$ are constants


```julia
function ODE_model(u, nn_params, t)
    χ, ϕ = u
    p, M, e = ode_model_params

    # In this example we know that `st` is am empty NamedTuple hence we can safely ignore
    # it, however, in general, we should use `st` to store the state of the neural network.
    y = 1 .+ first(nn([first(u)], nn_params, st))

    numer = (1 + e * cos(χ))^2
    denom = M * (p^(3 / 2))

    χ̇ = (numer / denom) * y[1]
    ϕ̇ = (numer / denom) * y[2]

    return [χ̇, ϕ̇]
end
```


```
ODE_model (generic function with 1 method)
```


Let us now simulate the neural network model and plot the results. We'll use the untrained neural network parameters to simulate the model.


```julia
prob_nn = ODEProblem(ODE_model, u0, tspan, params)
soln_nn = Array(solve(prob_nn, RK4(); u0, p=params, saveat=tsteps, dt, adaptive=false))
waveform_nn = first(compute_waveform(dt_data, soln_nn, mass_ratio, ode_model_params))

fig = with_theme(theme_web()) do
    fig = Figure()
    ax = CairoMakie.Axis(fig[1, 1]; xlabel="Time", ylabel="Waveform")

    l1 = lines!(ax, tsteps, waveform; linewidth=2, alpha=0.75)
    s1 = scatter!(ax, tsteps, waveform; markershape=:circle, markeralpha=0.25, alpha=0.5)

    l2 = lines!(ax, tsteps, waveform_nn; linewidth=2, alpha=0.75)
    s2 = scatter!(ax, tsteps, waveform_nn; markershape=:circle, markeralpha=0.25, alpha=0.5)

    axislegend(ax, [[l1, s1], [l2, s2]],
        ["Waveform Data", "Waveform Neural Net (Untrained)"]; position=:lb)

    return fig
end
```


![](1_GravitationalWaveForm-35.png)


<a id='Setting-Up-for-Training-the-Neural-Network'></a>

## Setting Up for Training the Neural Network


Next, we define the objective (loss) function to be minimized when training the neural differential equations.


```julia
function loss(θ)
    pred = Array(solve(prob_nn, RK4(); u0, p=θ, saveat=tsteps, dt, adaptive=false))
    pred_waveform = first(compute_waveform(dt_data, pred, mass_ratio, ode_model_params))
    loss = sum(abs2, waveform .- pred_waveform)
    return loss, pred_waveform
end
```


```
loss (generic function with 1 method)
```


Warmup the loss function


```julia
loss(params)
```


```
(0.1902245089196063, [-0.024301015264939895, -0.023513798559687996, -0.0227265818544361, -0.021396421955404938, -0.01949546261061822, -0.016983268364286732, -0.013806748131720259, -0.00989718579486247, -0.005172522626247417, 0.0004629627990604227, 0.007109338734546581, 0.014849790429413406, 0.02370231943805705, 0.03348960100631271, 0.04355649640930594, 0.05210217788895933, 0.05476861867827531, 0.04235423676404465, 0.0012602376798643187, -0.0673559403631339, -0.11060444237351569, -0.07541147129775681, -0.0057986442435527625, 0.03940172647031858, 0.054466966088609944, 0.05292105370125611, 0.044706319182167255, 0.0346420170842294, 0.02473815786099412, 0.015740000577775873, 0.007855639222838022, 0.0010810928898056548, -0.004665486899298975, -0.009485447049849419, -0.013476904454262733, -0.016723762821075874, -0.019297259407812926, -0.021252966036789948, -0.022632987414429113, -0.02346686317835518, -0.02377254211995555, -0.023556729106741073, -0.02281616889366287, -0.021535263157982956, -0.01968822679447961, -0.017236696434532905, -0.014128973227291258, -0.01029947475237868, -0.005667989465815775, -0.00014134151183017464, 0.0063787955283607185, 0.01397925040306684, 0.022685145578523195, 0.032351825031829755, 0.04240124633647379, 0.05122309426411297, 0.05487977054214607, 0.04489145022283726, 0.007832880813134333, -0.0589891039997324, -0.10931668148714771, -0.08298997681442934, -0.013317377369075437, 0.03600733262500932, 0.05395308469402249, 0.053668901915088885, 0.04584726940257926, 0.03580741123969423, 0.02579307423625355, 0.01664969333666894, 0.00861792213417074, 0.0017147477601884686, -0.004148226961084864, -0.0090633338251004, -0.01313985503322577, -0.01645671289053492, -0.0190943775542542, -0.021104245234810654, -0.02253561801859612, -0.023415851021196556, -0.02376698039498289, -0.023596370824021946, -0.022901161207995343, -0.021669360797513613, -0.01987651477818967, -0.017482903979597418, -0.01444480832163782, -0.010691597351246173, -0.006153413488502054, -0.0007312733691660152, 0.005663800617056866, 0.013127609551901245, 0.021686533450225365, 0.03123005670531219, 0.04124332143709969, 0.05029292289612986, 0.05482300391901236, 0.04704347162793237, 0.013896809748088258, -0.050463227341624284, -0.10677060890656538, -0.08994128202791281, -0.021236307974198603, 0.03214215812713012, 0.05320143235969138, 0.05433443327986959, 0.04697450189177098, 0.03698390193843741, 0.02686931213599596, 0.017575835370986777, 0.009401083868684322, 0.00235912579627096, -0.0036151515279962626, -0.008634631068093871, -0.01279189211224946, -0.01618569732608897, -0.018883685459971083, -0.020952499824092894, -0.022432787950016075, -0.023361654856579473, -0.023757553821071704, -0.023631602524763075, -0.022983218795901966, -0.02179885985384462, -0.02005890707881607, -0.01772391747667139, -0.014752380533671304, -0.011075798744330513, -0.0066271385712884925, -0.0013089028675684147, 0.004965340035844526, 0.012293112144328912, 0.020708262325524387, 0.03012295929728416, 0.04008724965392231, 0.04932023269541467, 0.05461482784122279, 0.048843964505342535, 0.019437872578889917, -0.04190884398605543, -0.10304256001879943, -0.09610280168734171, -0.029490075213922693, 0.02778054301586411, 0.05218827348145443, 0.054903563347070056, 0.048083299909663584, 0.038172421824737464, 0.02796010810866524, 0.018526913163318542, 0.010198080415236541, 0.003022342459671417, -0.003075803726630627, -0.008190140156068497, -0.012438801696239265, -0.015905385911040903, -0.01867095280358071, -0.02079272112285531, -0.02232712950304833, -0.023303025508932818, -0.023744487604712747, -0.023663534178004333, -0.023060490870631438, -0.02192494444154371, -0.02023411194337571, -0.01796131966226273, -0.015051909445703586, -0.011450405895908365, -0.007091214033500004, -0.001875147280789074, 0.004283365024448473, 0.011477639253323228, 0.01974722821457087, 0.029032436269610724, 0.03893500166985634, 0.048311503374925666, 0.05427710370063546, 0.05031695785762537, 0.02446717903943308, -0.03346424944986607, -0.09822001017147866, -0.10133057698175493, -0.0379964235174197, 0.02290919338323723, 0.05087944512125591, 0.05536493041536257, 0.049167804919278885, 0.03936697566793449, 0.029076126607698517, 0.01949277317435196, 0.011014676699694302, 0.0036970691369480704, -0.0025155623473604944, -0.00774095882902365, -0.012076259742650718, -0.015620365845128043, -0.018447108823373755, -0.020631572233503617, -0.022216528582784206, -0.02324069920006347, -0.023727324540729428, -0.023691677974378336, -0.023133946294826725, -0.022044709679623607, -0.020409166995563683, -0.018189196795025515, -0.015345434686884474, -0.011817595344013714, -0.007544017374073969, -0.0024277825963145722, 0.003615446345043978, 0.010678039135804625, 0.01880684527548681, 0.027958917242023238, 0.03778791369394886, 0.04727460906040011, 0.053822656794064914, 0.051494415134136, 0.028988557542074547, -0.02522666402973386, -0.09243179439464541, -0.10550013943371774, -0.04664087043759975, 0.01750553905765386, 0.04925284649434868, 0.05569951316404486, 0.050221549284651466, 0.040570352649774724, 0.03020651097085022, 0.02048108272690752, 0.011849421817600327, 0.004389852460367727, -0.0019468233706355488, -0.0072790175406223755, -0.011704849252627379, -0.01532672259177321, -0.018220449469060738, -0.020463802221920444, -0.02210154952621646, -0.02317423925273004, -0.023706695165203403, -0.023715928960431506, -0.02320348444179752, -0.022161532601464373, -0.02057665909153, -0.01841277891502531, -0.015632086644534738, -0.0121766076366622, -0.007986905874900625, -0.0037972041131393475])
```


Now let us define a callback function to store the loss over time


```julia
const losses = Float64[]

function callback(θ, l, pred_waveform)
    push!(losses, l)
    println("Training || Iteration: $(length(losses)) || Loss: $(l)")
    return false
end
```


```
callback (generic function with 1 method)
```


<a id='Training-the-Neural-Network'></a>

## Training the Neural Network


Training uses the BFGS optimizers. This seems to give good results because the Newtonian model seems to give a very good initial guess


```julia
adtype = Optimization.AutoZygote()
optf = Optimization.OptimizationFunction((x, p) -> loss(x), adtype)
optprob = Optimization.OptimizationProblem(optf, params)
res = Optimization.solve(optprob,
    BFGS(; initial_stepnorm=0.01, linesearch=LineSearches.BackTracking());
    callback, maxiters=1000)
```


```
u: ComponentVector{Float64}(layer_1 = Float64[], layer_2 = (weight = [-0.00012616052117655224; 0.00014660763554272914; 0.0001507099514129639; 2.20357178477273e-5; -8.254036220023638e-5; 1.870485357355734e-5; -1.595041248945644e-5; 9.260340448236069e-5; -3.5738386941368326e-5; -1.1666958016559417e-5; 6.125606887509607e-5; 2.1726267732437086e-5; 8.564301970181504e-5; 8.640379746773927e-6; 4.144657214057159e-5; -0.00010806799400610247; -8.746889761810483e-6; 1.6406022041320017e-5; -3.249045403206951e-5; -8.893241465556686e-5; -1.8538392396251645e-5; 0.00019251875346525612; -1.4560135241447794e-5; 8.841512317304719e-5; -6.717799988104871e-5; -5.720611807195178e-5; 0.0001704804744803672; -0.00012598338071252168; -3.8328653317860493e-5; 0.00010855933942353683; 1.110078483178918e-5; 4.470951171233533e-5;;], bias = [-9.950666018163917e-17; 2.1580428123062068e-17; -1.0510631489043668e-16; 3.2289644683724973e-17; 3.5828796474580886e-18; 2.529435709051483e-17; -1.8553669048281746e-17; 1.4908538129122e-18; -7.699314471430754e-18; -1.7885741078402454e-17; -1.6050326163029875e-17; 1.0611832038234808e-17; 3.898411033426103e-18; 2.1297123439693726e-17; -1.457497559124738e-17; 1.3260757743043624e-16; -1.3894803329580935e-17; 1.882522824869729e-17; -1.74570205617734e-17; -7.515024645677128e-18; -4.563123033953413e-17; 7.210900558770342e-18; -3.611533009478367e-17; -1.2047199328625467e-17; -4.9928173900281325e-17; 3.627469124277709e-17; 6.544273829805333e-17; -5.1549663226117214e-17; -1.6594592203952123e-17; 1.3566969940447813e-16; 8.060690452989327e-18; 9.762863880966549e-17;;]), layer_3 = (weight = [-6.961539527730147e-5 -9.444650693659376e-5 -0.00021123608947128616 -0.00010738086037201925 -0.0001313472972284415 8.142363314652689e-5 0.00011715177917756006 -0.00014644669916344407 7.06691202325367e-5 0.00015078743255833024 5.4067327637654714e-5 8.141032977049453e-6 -0.0002522352520642211 -3.027403961789472e-5 0.0002609072466115091 -3.819477187442659e-6 -1.1116510522357694e-5 -0.00010230924142854422 7.433170632827945e-5 -3.267579502755418e-5 -1.3985786226500162e-5 9.149972122067945e-5 -3.327943029910462e-5 -1.875068899573406e-5 -8.490409580156067e-5 6.57393388067937e-5 -1.3446278516863592e-5 -0.00012245188607231777 9.098667889736538e-5 -7.141012663816428e-5 1.42289392931479e-6 2.4911772398240656e-5; -4.019762694706989e-5 -5.856635674473425e-5 -1.5641271818198512e-5 2.4622988132901328e-5 1.2042808305256572e-5 0.0001397616813507881 -3.346620927667048e-5 -1.4208197387502312e-5 -4.052673306185679e-5 0.00016616741210120014 -6.837872773511563e-5 8.736676842337646e-5 -2.7746122429829223e-5 0.0002081484069664985 -0.00015250675481846536 -3.8345571954141214e-5 0.00021629883282250017 0.00015427467020591917 0.00016897188630784032 4.0159733328169313e-5 4.878890888645087e-6 -6.547123324465568e-5 0.00011490003249738567 3.264265047865195e-5 3.1367953967765687e-6 -4.0266708526622346e-5 -5.464659101319088e-5 -0.00015303228268503987 7.477197665385954e-5 -2.8007756770693655e-5 0.00016315219705822164 0.0001217731276144272; -1.8748426503737114e-5 6.509636210160822e-5 9.099152435431707e-5 -2.9977968500458567e-5 7.892230410710978e-5 -4.04534302500513e-5 -4.690140935359227e-5 2.851449158391923e-5 0.00019611145313014534 8.989043186069767e-5 -7.668720440356816e-5 7.666738435221454e-6 -8.277409592061253e-5 4.470008121338043e-5 8.120683838264329e-5 5.388302730047045e-5 3.0625611149328606e-6 -9.146760652889201e-5 -7.14875722618281e-5 -0.00011565462131635256 0.00014613422450260546 -1.8122532258867728e-5 0.0001142923275043752 -9.070230675511961e-5 -8.051453273161164e-5 3.078191644512307e-5 3.098252914845244e-5 4.702646679710353e-5 -0.00013060781288309705 -4.643836741102962e-5 0.00011527405063738416 -2.3981598991083428e-5; 1.0497093636149113e-5 -7.974093977208949e-5 -1.92990682007578e-6 0.00015756513085834047 2.6698342035884063e-5 2.7847281226779497e-5 -0.00015111629408166456 1.2827521014329325e-5 1.5194742910164482e-5 -0.00010777553187763962 -0.00017101915226631364 0.00017029316723964473 -0.00011018895974230369 -6.537170928750833e-5 2.2933026694584428e-5 -4.094139739136383e-5 -0.0003472976045388421 -1.7189675863126164e-5 9.706049705339577e-6 9.148847085343348e-5 5.880091476755511e-5 -2.173476802372878e-7 -4.5089180720613247e-5 -8.702172862213434e-5 -0.00016708975680485832 5.146869581112122e-5 0.00015444389056101985 6.498572976015511e-5 0.00014326218434761615 -2.141204804069869e-7 8.953569114127483e-5 -1.8977047592858875e-5; 0.00011007882100711414 6.585207999632614e-5 -9.079744661976644e-5 2.7317422490516428e-5 0.00019829022464290888 -0.00026708850812684216 3.791661189933838e-5 4.121031151220243e-6 8.389121619001576e-5 4.427979699284367e-5 7.927887024306344e-5 0.00010952221752558438 2.0496661517603175e-5 -0.00010757497541890884 -3.965044045872434e-5 -0.00022113440384674112 -0.000153604931557136 1.0366301166134136e-5 -0.00018248325098357555 -6.443122431920195e-5 -3.4989466992625194e-6 0.0001519987778639902 8.807965757040837e-5 -0.00010862441588943179 0.0001683515508095234 -0.00019836698659747267 6.112158704963548e-5 0.0001266359828779923 0.00012854807543516707 2.7776273481498996e-5 -3.618645162606084e-5 -0.00018064645003579004; 1.645859034497851e-5 7.018699712817394e-5 8.322757954475353e-5 3.6647353646093804e-5 -0.00017313673428261434 -5.8432419372275695e-5 -3.3172225711503077e-6 -0.00017485703259708077 -4.715893059155892e-5 -8.354380091886997e-5 -1.0369467908184856e-5 -0.00017702577728314346 5.6848737095699244e-5 -6.987982172986525e-5 -4.196441708600121e-5 0.0002728345893602672 0.0001012943425494988 1.7978839842816564e-5 -0.00020617892418058585 -9.359768277035767e-5 0.0001926559957256352 5.592439216444688e-5 6.921698101095828e-5 6.983851513823749e-5 -7.471225811868773e-5 -0.00014530081219972952 0.00014868509921244465 -0.00013022306351458097 -1.3312884710922176e-5 -0.00010050329414197773 0.00016196801467331092 -2.9887509789568903e-5; 4.2157095221990344e-5 5.403781723528989e-5 5.929511861707848e-5 7.729580137479055e-5 -1.2420810982411363e-6 0.00019128941529729347 -0.00018354329914487024 0.00016669324430935574 1.546012789717307e-5 4.1689269337299723e-5 -1.492143802366204e-5 2.4146569912633208e-5 -0.0001156507856741493 -2.577721134926239e-5 0.00012109455600679729 -0.00011374219285258677 -7.512606644936882e-5 -0.0002031413965688931 -1.8224088862692927e-5 -4.577060835943007e-6 1.4904633089687555e-5 -2.3597489062169544e-5 -3.083913871719555e-5 -4.6707740339259026e-5 0.00010880686058030209 7.992744976022087e-5 -9.406409627460405e-5 3.729723938689717e-5 0.0001728185092268594 6.120192155307499e-5 -5.7204407867314775e-5 7.545844017826818e-5; -5.558946356718772e-5 -2.650547282788099e-5 -0.00014158110714011546 2.2284410466504002e-5 4.4452039456257266e-6 -0.00016050259871367017 3.590600902139564e-5 -1.757296338287199e-5 0.0001064940210435943 2.824638470524816e-5 7.64751370534693e-5 -4.556626079097046e-5 2.20822188803604e-5 8.635490523925414e-5 0.00011119642879389515 1.6962038376776815e-5 0.0001951430662539265 -5.717807432478871e-5 -0.00013451200500089354 -5.3593632013825565e-5 0.00013130174777511855 -6.435006516436358e-7 9.527953664115056e-5 4.5446644822778355e-5 -9.689710690461315e-6 -8.117856630082954e-5 -0.00019435794963461347 0.00013634913777973157 0.00016174224440515338 3.594352385884922e-5 -2.9691150824824473e-5 1.6234848249999783e-5; -4.040065440078088e-7 4.657565572839972e-5 5.9332985115059e-5 -6.097211094614837e-5 -0.00013120997842209974 -2.6821870920083257e-5 -1.7905113923314757e-5 3.847504599128826e-6 -0.00013149481761078115 2.2974996178722375e-6 0.00012818859162931626 4.764368263264399e-5 1.7081844857478646e-5 -7.062452000840364e-5 -3.0964817556503586e-5 0.00021003733767853612 -0.00016580031747738625 -0.00010996464784997308 -4.138585514314246e-5 -9.792810392840365e-5 3.944700351408892e-5 0.00013773998857202213 0.00010113198281456922 -8.536959008355227e-5 -6.362389918225503e-5 0.00015276513208360696 -8.801716554019597e-5 -4.976493888110253e-5 -5.93877311578928e-5 1.5414000740442747e-5 8.959008759544435e-5 -6.487790829249243e-6; -6.38287194567195e-5 1.3811814616278154e-5 -1.0401993885094026e-5 0.00010136018388155719 -8.931051272949369e-5 -7.286695766080298e-5 3.4014462263517656e-5 -6.724588022617797e-5 -6.193312877141072e-5 4.107273777779995e-5 7.167632863573581e-5 7.670805350361263e-5 -5.271484250183494e-6 2.7907254453826345e-5 -8.66630245843357e-5 -1.1364090122438085e-5 2.3885450184803987e-6 3.3742177739700883e-5 1.8521722059891155e-5 6.889937937674873e-5 -4.636988090052398e-5 -5.208341392855491e-5 -8.682818154621995e-5 -2.1218130522097303e-5 -6.059065274595434e-5 8.727175442917127e-5 7.034127772502315e-5 0.0002260838343966358 -2.7800116393986583e-5 -4.181058032255812e-5 -6.555740695031486e-5 3.8235354414869586e-5; 8.548314828254932e-5 -4.232021500177653e-5 -5.165879746021606e-5 -0.0001765847814426219 -7.16735243661384e-7 1.66729601146958e-5 -5.312462279511834e-5 -3.490606512463408e-5 -2.7641572600665256e-5 3.00055321673002e-5 3.0859554968224605e-5 -5.49313667619994e-5 0.0001166553734179231 -0.00011173354549505044 -2.6303060153118776e-5 -5.988774908877494e-5 6.904178327709209e-5 -1.9825424573778456e-6 0.0001163464362576214 -4.202486933030913e-5 -0.0001543465154868013 0.00011155683343129192 -9.982559684835594e-5 6.258883345761256e-6 -8.229004423305373e-5 3.804301697123745e-5 9.26202587975886e-5 4.80127087171813e-5 -6.399507809369044e-5 5.1842212556548896e-5 3.0494800426398487e-6 -0.00014482925733722867; 0.00016646474737521663 1.3554479986707172e-5 7.111365025943165e-5 0.00017393031644483435 3.399201282613895e-5 -4.678441714181217e-5 0.00018120890795567427 3.082937960593845e-5 -9.136436223902442e-5 0.00013686903307994256 -0.00013873828961199922 -2.838776949478904e-5 6.949193389468781e-5 1.3244832511058918e-5 -8.587221278636335e-6 -9.313143040904131e-5 -0.00021989539768232602 2.44301184955973e-5 2.5105085436602408e-5 0.00015883507635758184 0.0002464727780114615 -9.170054058465032e-5 0.0001442437254389504 -0.00013582422493177537 -0.00017463402277476039 -6.200936572545025e-5 7.753196892175488e-5 2.2497520470865396e-5 1.969822310807468e-5 -0.00018065476128517944 8.476388516451593e-5 -2.164665962615177e-6; 3.783408141476364e-5 0.0001285744514841551 -0.00014403687924482414 -6.525764871023493e-5 8.360244141091928e-5 0.00010396339388696594 7.207092898331709e-5 4.7522535571047584e-5 4.263149134364925e-5 -2.8751485917604145e-6 -7.82686616350736e-5 -3.389457520663634e-5 5.994804127273428e-5 -6.609669031442928e-5 -8.858598408389871e-5 -5.91800558670351e-5 0.00010882618557095674 2.19408706850804e-5 1.8954486624147213e-5 2.6052266950288135e-5 0.00015878680318726345 0.000132411136693673 9.27548248380622e-5 -9.72642733888585e-5 4.4035507418603e-5 -5.8043500355987064e-5 0.00013976983649785371 5.481422380558483e-5 7.399361533477896e-5 6.511447321987497e-5 -3.32539744324316e-5 1.5972566363210144e-5; -0.00010128461578541375 -0.00010107044797304275 0.00010913647131847903 2.5900721800157004e-7 -2.080507944891224e-5 -1.1056150261428495e-5 -6.013233794044867e-5 7.159745585260372e-5 -2.144687348016282e-5 6.185943059710626e-5 -4.874536235439319e-6 2.381505258119491e-5 7.803246072555727e-7 -6.366510640043922e-5 0.00013266979952197296 -6.30389738679559e-5 0.00010491872965678416 -6.046151681482956e-5 -2.5673628177898018e-6 -0.00011097309904551644 0.00020688413062918765 0.00010467820832591543 1.0989683895896429e-5 -2.0408681640113167e-5 1.287521011283265e-5 3.165697419637513e-5 -6.445619944396963e-5 -5.514568035404135e-5 -3.907628412969629e-5 1.6549661476451576e-5 6.088515804469427e-5 0.00018927498897857722; -9.165616230399097e-6 -6.039224774309411e-5 -7.377135500161047e-5 0.00011443001983839766 -0.00015460680753771945 3.6692055235977644e-5 0.00017701837476029756 2.5137010542448354e-5 3.076091650560184e-5 9.131014065038186e-5 0.00012319983341417705 -4.391658751141533e-5 -8.08834289464804e-5 -8.540562358614888e-6 -2.725789510900036e-5 -5.069172277312894e-5 0.00015778002978455053 -7.770645481381801e-5 -0.00011756071637232151 7.214705818018994e-5 -3.6224761625856726e-5 -1.9372563311729927e-5 3.0699925790901763e-5 -7.289571495720809e-6 6.772816539428571e-5 -0.00011019340183433609 9.771360908319625e-5 8.626893520972208e-5 -7.78564777838658e-5 0.000269396566526618 -1.7140113978751406e-5 0.00015961393490120402; 0.00017913354041121452 0.00015167753973110545 1.895457590472271e-5 -2.340624395689888e-5 -0.00013066500595703334 4.091173341915063e-5 -6.339844311985128e-5 0.00014173393956918494 9.441399252575789e-5 -9.894481390180925e-5 -0.00013677404548905118 7.443360173677133e-5 -5.536496149196862e-6 0.00019258896882713854 5.953862146891578e-5 -0.00016214538244929227 1.7732205930613747e-5 0.00012716722504303856 3.647585442038116e-6 7.188118125379371e-5 2.9029077820112522e-5 9.199870929186626e-5 -2.8862928405189246e-5 4.7115193053123684e-5 0.00012319869948153054 7.206461542120917e-5 -2.0591406967651913e-5 9.964486350156533e-6 -3.0374779628958134e-5 2.045185338539931e-5 -0.00013197984425748622 -4.402583126027239e-5; -2.43656650339537e-5 4.502132831173849e-5 5.605046133194108e-5 -1.2266713368622713e-6 6.402447795759644e-5 -2.682311971815553e-5 5.9572646911565445e-5 -2.639048400245256e-5 -2.300497001064192e-5 -8.58046896822451e-5 0.00013400108034753707 6.881106126153136e-5 -2.3911045658079214e-6 -0.00021755599120600882 0.00018778411502049622 -0.00019984223583681396 6.837325233997042e-5 1.7197791727685607e-5 -0.00011576617364275002 -4.920657558917231e-5 2.2303025595338376e-5 1.4656492545955004e-5 -0.0001799946312742939 -4.49350718766561e-5 9.13120911506336e-5 4.2501282202158694e-5 -2.929279619212742e-5 -7.792273938623769e-5 -0.0002774282893581938 5.4680751397126626e-5 5.299216898189125e-5 -0.00014085206023386343; -0.00011754423885490426 -2.6986946430991407e-5 0.00011085997412097433 -6.036702452461834e-5 1.8176499544049264e-5 3.335346864418452e-5 6.523648935485022e-5 -8.57576173066732e-5 -2.1656397983912286e-5 2.4859706719274044e-5 7.370712282949656e-5 0.00013981690299346442 0.00010605198494972472 1.7306784321538472e-5 -0.0001312777980265819 4.747376315294832e-5 -0.0001608627002488512 -0.00010439753659653156 5.473151851168552e-6 0.00015984482033759204 -4.2514298365001115e-5 -4.095741950580209e-6 -0.00013100294145174942 -5.443232057500793e-5 -2.245577834315025e-5 -0.00011786879022025004 2.9829425876379787e-5 -0.00011127194866189418 0.00015319524991440974 1.7314336765548964e-5 -0.00011529977327796317 -0.00012820695101168513; 8.301519511368624e-5 8.991788882630872e-5 9.594564571304688e-6 -0.00013936843942285283 -4.980585771628863e-5 -3.12409462734848e-5 -0.00015881285407014909 7.632765874367138e-5 0.00010559024331958328 -3.8426682013252515e-5 -5.820258565146919e-5 7.258184296877356e-5 -3.6203822392431815e-5 -9.660754193684816e-5 5.362754410232749e-5 -7.233043624220247e-5 3.118801060698199e-5 -0.00016418274362006008 -0.00010032175095186291 2.0150390182229403e-5 -2.7414232763859997e-5 -1.0548338368963092e-5 -8.13721669059505e-5 5.321248710023109e-5 0.0001650331362812555 -0.00010181044098355359 -3.1245810251127704e-5 1.2583506131333106e-5 -1.9261136631413046e-5 -6.343345347923981e-5 -7.295958102115224e-5 3.542443718815369e-6; -7.524925613890868e-5 -7.96521490940146e-5 0.000121158351151994 -0.00015351283228141874 -6.59471771598307e-5 -0.00026031943717157174 -9.686176791205719e-5 6.491581725073483e-5 0.00015128650547353967 -0.0001565128551248993 -5.146411068039207e-5 2.9555134403864786e-6 -5.818980581010416e-5 -2.5769180962240523e-5 -0.00015437934062560545 0.00013696795930970371 -4.998904851731584e-5 0.00010201989779830265 0.00010771246879244612 -0.00014365424440824077 -0.00015084811466863085 -1.2658501060463363e-5 -9.112320558983554e-5 -6.96732314338408e-5 6.701626252266487e-5 8.562299616983838e-5 -0.00010266994659669379 8.118994437043084e-5 -3.001524743236028e-6 -9.26466164912477e-5 7.877559245912625e-5 -7.114309856319288e-5; -2.740756454788931e-5 -5.7714665590015805e-5 -1.9615086702675246e-5 0.00017048568960542529 1.28367674647732e-5 -5.524527469735855e-5 -5.633852370867768e-5 0.0002552814167671156 -0.0001237753839717925 -3.5587881856758905e-5 0.00011434311280988814 7.887324872224327e-5 -6.723717698098448e-5 9.59423324189402e-5 -9.128399114388465e-7 -0.00010546931472110865 -2.2367790651901454e-5 -6.971039138936701e-5 0.00023304073519336726 0.00012507073378453673 -2.1539357562005295e-6 -0.0001405531456015764 5.74987517125692e-5 -0.00010871864825223862 -1.3434204365171472e-5 2.022087946040748e-5 4.306312083879124e-5 -6.522856884605566e-5 -0.00011178582818449742 3.805972854986484e-5 1.1555666870276614e-5 -0.00014691359857299633; 7.571368227607521e-5 -9.121538783546467e-6 -1.050635997282316e-5 -0.00019880023860943197 8.365053694822987e-5 -0.00010290896712441621 0.00012844603956572092 -1.6489500881758254e-5 -0.00016587894602318007 7.231225940293947e-5 0.0001364257132484321 0.00025883878155972184 -2.9344160753421864e-5 0.00013118101382523159 3.7919830032738844e-5 6.256145028990741e-5 -2.799258432397768e-5 -7.586922397941972e-5 -5.0333635914024754e-5 -3.341274892201512e-5 -0.00017580992967460927 0.00014186914817789962 0.0001455450201722545 -0.00011196020018880117 6.694536027160688e-5 -9.549748752371165e-5 -8.37563693091588e-5 8.91436895274036e-7 4.967560566391149e-5 -9.926691705656252e-6 5.579868779412787e-5 -7.88236920522778e-5; 0.00012879878393444303 -3.23050839330571e-5 -5.344518233021239e-5 9.280590218562955e-5 -3.266198420593678e-5 -2.8281670366284838e-5 0.00013665133208573202 8.833913470275522e-6 0.00018565902480926626 -0.00015557298267654727 -3.317127421415507e-6 -2.1622086406440038e-5 -8.488466794066336e-5 -2.19731586372817e-5 1.704595213535935e-5 -9.757970057823298e-5 1.6187678356202126e-5 -7.92974746406417e-5 -0.00011170082818412874 -0.00016903738962415854 0.00022073325870164068 0.0001563566771249598 0.00033017068979401495 7.737331232359394e-5 0.00014209628041438773 0.00016484959685780218 -4.360925178905951e-5 9.25566497056287e-5 -9.704632922935984e-5 3.0959505765469896e-5 -2.2751673369073536e-5 -0.00016997952427178414; 7.736362733707959e-6 7.025492121320261e-5 -7.011561066756018e-5 -3.239104373059507e-5 6.134313187649949e-5 0.00020079139247392038 -0.0001812729398967259 -0.0001431412321995529 -4.921065303059589e-5 -3.717625915450305e-5 -4.374952297220375e-5 -0.00011482931696954452 -0.0001070867230897351 6.881108018425036e-5 0.0001752791202146995 -8.75598209109683e-5 -7.620380458100957e-5 -7.850028597894389e-5 6.586656384033298e-6 -0.00010047972429455749 0.0002158557679489694 0.00011902553413383247 3.0283644066375843e-5 1.5330867229210933e-5 0.00011344478005631439 -0.00014776938152644205 -1.635864029376483e-5 9.58027219734548e-5 2.3716339257961867e-5 0.00012743645382434456 0.00010116808587773444 6.608228321275359e-5; 5.86280993447598e-5 -5.683642990367299e-6 3.361397188560862e-5 -1.65409028850379e-5 -0.00012281611912478175 -5.523047599138046e-6 -8.284574105459738e-7 -6.885766111374493e-5 -0.00012034728484287703 4.93924062029579e-5 4.023092918927039e-6 0.00015179154519863661 -1.3606760199782425e-5 7.81013376981607e-5 -0.00010777509947366902 -0.00012392122067105931 3.43396067764731e-5 0.00020172680610265842 0.0001341669785178843 -6.40122880722821e-5 0.0001467171031836073 -7.967392508003641e-5 3.84927379345641e-5 4.9876086399289295e-5 0.0001872052898251993 2.6781085529350194e-5 -8.555322034267122e-6 4.262912711416896e-5 -1.065201473103467e-5 5.604312258944859e-5 8.215129577728264e-5 0.00011599779185779476; 4.7818025122930675e-5 -8.609092547020816e-6 -6.324862952213397e-6 3.061511473782666e-5 6.707950400590658e-5 -2.5359094579528832e-5 1.8354142084660136e-5 0.00022098959620047226 -2.0178252598327765e-5 -8.966664732730662e-5 -6.218543545406738e-5 -5.8442351801261984e-5 3.0420861221447374e-5 -6.869762124557696e-5 2.1263912130905406e-5 -0.00017529331067640277 2.8621818855696373e-5 -0.00014952422621723903 4.690903610020285e-5 6.831277882151134e-5 1.1453328297590553e-5 -5.932232794297183e-5 -6.628660172288016e-5 3.343749871413976e-5 -1.8332689578583532e-5 -2.5717546450379197e-5 -9.009555775268746e-5 5.216642115551362e-5 -5.590140550344817e-5 5.5163566357754816e-5 -0.00012844689750642234 -6.607149531197337e-5; 4.488621020909894e-5 8.069920845783122e-5 0.00013770770424499033 4.4662419942773976e-5 -1.2536524034933131e-5 -7.014400078610711e-6 -2.596017288697604e-5 -1.7426444126887355e-5 6.130146907862134e-5 -1.6854906742360495e-5 5.233578623752931e-6 1.8491451116412398e-6 -8.80512834085512e-5 -0.00011993762195589216 2.9746906922532885e-5 5.6473692940653614e-5 -4.0025928636446674e-5 0.00011133072807906009 -2.4311342666173937e-5 -9.308812327463035e-5 -0.0001654008464795928 -0.0002389526434383586 4.765241287868282e-5 1.8217839216684486e-5 1.9724633649908927e-5 -0.00014566303611746113 4.369292769452692e-5 3.5489875260300876e-6 1.700641225120462e-6 2.6829076934245775e-5 -8.481143772615312e-5 2.9717548433559773e-5; -3.200454912275444e-5 -5.3873152776031007e-5 3.966674748680862e-5 2.0179884902799753e-5 3.395037319733736e-5 3.888670298493685e-5 -4.599262856771948e-5 0.00010939292960557063 -1.7612344801992226e-5 -5.173964555268882e-5 0.00019039340813634071 4.0310851634612574e-5 1.945722587862006e-5 0.00021376215417859374 -0.00015796884863647465 7.115578600660691e-5 2.9932765844759934e-5 0.00012672802231264525 3.570999806271126e-5 -0.00020102766020699473 -8.689647247792005e-5 -7.601505231123648e-5 -9.895216671992803e-5 -0.00016396013407046973 0.000194552301852862 -0.00019172316560997523 0.00013825407049607557 -2.2087669915160106e-5 -3.247407030557107e-5 -5.292194500925232e-5 0.0002249401059978571 3.7557280027439516e-5; 9.802505376590152e-5 0.0001252237693088149 7.928946290938483e-5 -0.00011154140663260284 -0.00010279008854107094 0.00014889662127549132 -0.0002535433610055752 0.00011793029846464339 -0.00019698222019636625 -0.00015087732897067156 -8.774416489453403e-5 -1.978466713902696e-5 3.800529741872054e-5 5.639886369768808e-5 -5.00159308749396e-5 -5.332159850788921e-5 -0.00014511804472116472 -7.991757008406974e-5 2.3218072264137542e-5 -1.2826793473351286e-5 1.5780561106077594e-5 0.00020102779529133444 -6.544042987210388e-5 5.109329361309289e-5 7.690144268869137e-5 0.00017970950141622298 -8.033261253423156e-5 4.2252750453350254e-5 -6.331509354916937e-5 -0.00017205845649280265 -0.0001228590422861436 -9.845005258379066e-5; -3.2024579714378346e-5 3.081820816933118e-5 0.00013189741569422114 -4.721783058866697e-5 -7.849669215883966e-5 -8.4212335214576e-5 6.83294331151077e-5 5.090432226043272e-5 4.701090640938062e-5 1.6055914083520665e-5 -6.1019583673075434e-5 -0.0001320713288538142 0.0001346267147067943 8.079391975971103e-5 -2.027441287825033e-6 -0.00014131955119464504 2.523054738904049e-5 0.00010510140257738694 0.00014549973114244793 6.523982146429729e-6 4.239885877669021e-5 -5.054113514288551e-5 2.6647414682915057e-6 -4.8890751505130045e-5 -1.5753523899521448e-6 -2.4347451263199177e-5 -4.971279647234034e-5 5.675324630774557e-5 -9.798019325043857e-5 -0.00012336564556844493 1.3146558766860302e-5 9.567024083426366e-5; 1.2608995591518784e-5 -5.402024792834008e-5 6.774279724363343e-5 3.7174040857835445e-6 -5.42351251465725e-5 -3.12022409457667e-5 4.4868678075964604e-5 -0.00015785136086610154 8.237666158262122e-5 9.852650079434284e-5 -3.649193852883495e-5 0.00012073210497643326 0.00010499365568417186 0.00012251270642760686 -1.8875324469754346e-5 -3.026119041582759e-5 -0.00011801063258875612 -3.4158269711532595e-5 0.00015337141054938967 1.5458065961371456e-5 6.773801730979456e-6 2.3211326395028496e-5 -3.4878571325442685e-5 6.194291261141523e-6 -6.051771081960537e-5 -7.139891270757354e-5 0.00012734482995023692 -2.4945759219451643e-6 -6.829864172008418e-5 4.076004667463518e-5 -3.454105056565709e-5 0.00020905441603414154; 0.00011081603242277474 4.457835183788157e-5 5.9050693555800375e-5 1.050080044738058e-5 -8.344271537421503e-5 0.00016487322517864456 -0.0001138815894656996 -8.318286909994046e-5 4.7836703918483175e-5 -6.072373053680118e-5 8.502015788767388e-5 9.714322022123302e-5 -2.563179423955524e-5 5.7534755062852644e-5 4.762319458027358e-5 4.728066135471692e-6 -0.00011877424895569627 9.230718223338994e-5 9.650323426544681e-5 -9.702471634878125e-5 0.0001036247596792695 9.436432828154742e-5 -1.61714522684174e-5 -8.797058017730988e-5 -7.086274473035842e-5 -8.197630432473576e-5 -8.020687874446884e-5 2.270554153113221e-6 3.651472088026813e-5 4.844853555627653e-5 -3.897753395644891e-5 7.105250933168431e-5], bias = [-2.0159674264447917e-9; 3.792377097956437e-9; 1.0687077914013335e-9; -1.2755565037813654e-9; -4.732381127289132e-10; -1.1610053669459832e-9; 1.4628220438419046e-9; 1.4028283245224722e-9; -7.866722977233944e-10; 1.7168648413974742e-10; -1.7284805350849246e-9; 1.7510991300894252e-9; 3.4492057018711063e-9; 1.399920730255274e-9; 2.3441125058264307e-9; 2.8690981966426854e-9; -2.2828529290455075e-9; -1.8711935418884232e-9; -2.4044224320689836e-9; -4.067356937861602e-9; 1.0740275232774136e-10; 7.221790714326199e-10; 2.372489090873207e-9; 9.229392253260848e-10; 3.2095558597508883e-9; -1.914813823097374e-9; -1.36237604741198e-9; 1.1696991440551377e-9; -2.6062216768866135e-9; 3.25807744435329e-10; 1.7910383224497696e-9; 1.349865534029394e-9;;]), layer_4 = (weight = [-0.0004922210222645149 -0.0006971084078042852 -0.000829302219475365 -0.0006478773717989302 -0.0005987610847066571 -0.000776833626445291 -0.0005170862639684909 -0.0004457478751239925 -0.0007324917423670727 -0.0007443949061568432 -0.0007612325436640613 -0.0007829309385507278 -0.0005549053241516521 -0.0008051887989168689 -0.000829257353022124 -0.0008146639023772833 -0.0007720479337735536 -0.0006414168113423919 -0.0007801215339600672 -0.0006998944062395015 -0.0008777607903204139 -0.0007270875868710004 -0.0008291295400273047 -0.0005319552309759972 -0.0005618244289087967 -0.000532266734330126 -0.0005293580151459065 -0.0007379160152926327 -0.0006694731318605088 -0.000801750961925259 -0.0008104042376390568 -0.0006495819513337092; 0.00012159035318857591 0.00032577375853380566 0.00032677454802555224 0.0005119094680198161 0.0002190271410984662 0.00030481589604072664 0.00016925436483983117 0.0003004424973643578 0.00019359259010737225 0.00018835504725759665 0.00017871929203515467 0.00021781091798118093 0.00036791420871043235 0.0002776543132835949 0.00022064127615792735 0.00017029656852322102 8.527913966499294e-5 -3.06348940995274e-5 0.00022522301099918456 0.00027722021897254236 0.00013636752439302553 0.00016933285178766382 0.00028489335962926705 0.00027856280367222826 0.0002264129097015474 0.0002642693624678873 0.0003205606950932931 0.00028377157107660906 0.00019511784069415665 0.0002572121248743284 0.0002646766750058784 0.00015760201458813627], bias = [-0.0007092380434450593; 0.00020490524802658556;;]))
```


<a id='Visualizing-the-Results'></a>

## Visualizing the Results


Let us now plot the loss over time


```julia
fig = with_theme(theme_web()) do
    fig = Figure()
    ax = CairoMakie.Axis(fig[1, 1]; xlabel="Iteration", ylabel="Loss")

    lines!(ax, losses; linewidth=2, alpha=0.75)

    return fig
end
```


![](1_GravitationalWaveForm-48.png)


Finally let us visualize the results


```julia
prob_nn = ODEProblem(ODE_model, u0, tspan, res.u)
soln_nn = Array(solve(prob_nn, RK4(); u0, p=res.u, saveat=tsteps, dt, adaptive=false))
waveform_nn_trained = first(compute_waveform(dt_data, soln_nn, mass_ratio,
    ode_model_params))

fig = with_theme(theme_web()) do
    fig = Figure()
    ax = CairoMakie.Axis(fig[1, 1]; xlabel="Time", ylabel="Waveform")

    l1 = lines!(ax, tsteps, waveform; linewidth=2, alpha=0.75)
    s1 = scatter!(ax, tsteps, waveform; markershape=:circle, markeralpha=0.25, alpha=0.5)

    l2 = lines!(ax, tsteps, waveform_nn; linewidth=2, alpha=0.75)
    s2 = scatter!(ax, tsteps, waveform_nn; markershape=:circle, markeralpha=0.25, alpha=0.5)

    l3 = lines!(ax, tsteps, waveform_nn_trained; linewidth=2, alpha=0.75)
    s3 = scatter!(ax, tsteps, waveform_nn_trained; markershape=:circle, markeralpha=0.25,
        alpha=0.5)

    axislegend(ax, [[l1, s1], [l2, s2], [l3, s3]],
        ["Waveform Data", "Waveform Neural Net (Untrained)", "Waveform Neural Net"];
        position=:lb)

    return fig
end
```


![](1_GravitationalWaveForm-50.png)


---


*This page was generated using [Literate.jl](https://github.com/fredrikekre/Literate.jl).*

